<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>facejam.cc è´´è„¸é…±</title>
    <meta name="description" content="ğŸ¥° AIé©±åŠ¨çš„è¡¨æƒ…è´´çº¸ç”Ÿæˆå™¨ï¼Œè®©ç…§ç‰‡æ›´æœ‰è¶£ï¼è‡ªåŠ¨äººè„¸è¯†åˆ«ï¼Œæ™ºèƒ½è¡¨æƒ…åŒ¹é…ï¼Œéšç§å®‰å…¨æœ¬åœ°å¤„ç†ã€‚">
    <meta name="keywords" content="è´´è„¸é…±,FaceJam,è¡¨æƒ…è´´çº¸,AIäººè„¸è¯†åˆ«,ç…§ç‰‡ç¼–è¾‘,emoji,è´´çº¸ç”Ÿæˆå™¨">
    
    <!-- Favicon -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ğŸ¥°</text></svg>">
    <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ğŸ¥°</text></svg>">
    
    <!-- Open Graph / Social Media -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://facejam.cc/">
    <meta property="og:title" content="facejam.cc è´´è„¸é…±">
    <meta property="og:description" content="ğŸ¥° AIé©±åŠ¨çš„è¡¨æƒ…è´´çº¸ç”Ÿæˆå™¨ï¼Œè®©ç…§ç‰‡æ›´æœ‰è¶£ï¼">
    <meta property="og:image" content="https://facejam.cc/assets/kay_happy.png">
    
    <!-- Twitter Card -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="facejam.cc è´´è„¸é…±">
    <meta name="twitter:description" content="ğŸ¥° AIé©±åŠ¨çš„è¡¨æƒ…è´´çº¸ç”Ÿæˆå™¨ï¼Œè®©ç…§ç‰‡æ›´æœ‰è¶£ï¼">
    
    <!-- Tailwind CSS: ä½¿ç”¨CDNï¼ˆéå¸¸å°ï¼Œçº¦3KB gzipï¼Œå»ºè®®ä¿æŒCDNä»¥è·å–æœ€æ–°ç‰¹æ€§ï¼‰ -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Face API JS: ä¼˜å…ˆä½¿ç”¨CDNï¼ˆä¿è¯ç¨³å®šæ€§ï¼‰ -->
    <script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
    <!-- å¦‚æœéœ€è¦ä½¿ç”¨æœ¬åœ°ç‰ˆæœ¬ï¼Œå–æ¶ˆä¸‹é¢çš„æ³¨é‡Šï¼Œæ³¨é‡Šæ‰ä¸Šé¢çš„CDNç‰ˆæœ¬ -->
    <!-- <script src="./libs/face-api.min.js"></script> -->
    
    <!-- Google Fonts: ä½¿ç”¨CDNï¼ˆå­—ä½“æ–‡ä»¶è¾ƒå¤§ï¼Œå»ºè®®ä½¿ç”¨CDNï¼Œæœ‰æ›´å¥½çš„ç¼“å­˜ï¼‰ -->
    <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-XXXXXXXXXX"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-XXXXXXXXXX', {
            'page_title': 'facejam.cc è´´è„¸é…±',
            'page_location': window.location.href
        });
    </script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Fredoka', 'sans-serif'],
                    },
                    colors: {
                        bg: '#FFFDF5',
                        dark: '#000000',
                        accent1: '#FF90E8', 
                        accent2: '#23A6D5', 
                        accent3: '#FFC900', 
                    },
                    boxShadow: {
                        'hard': '4px 4px 0px 0px #000000',
                        'hard-sm': '2px 2px 0px 0px #000000',
                        'none': '0px 0px 0px 0px #000000',
                    }
                }
            }
        }
    </script>
    <style>
        body {
            background-color: #FFFDF5;
            background-image: radial-gradient(#000000 1px, transparent 1px);
            background-size: 24px 24px;
            color: #000;
            height: 100vh; 
            height: 100dvh;
            width: 100vw;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        
        canvas {
            touch-action: none;
            display: block; 
        }

        .neo-card {
            background: #FFFFFF;
            border: 3px solid #000000;
            border-radius: 1rem;
            box-shadow: 6px 6px 0px 0px #000000;
        }

        @media (max-width: 640px) {
            .neo-card {
                box-shadow: 3px 3px 0px 0px #000000;
                border-width: 2px;
                border-radius: 0.75rem;
            }
        }

        .neo-btn {
            background: #FFFFFF;
            border: 2px solid #000000;
            border-radius: 0.75rem;
            box-shadow: 4px 4px 0px 0px #000000;
            transition: all 0.1s ease;
            font-weight: 600;
            cursor: pointer;
            user-select: none;
        }
        
        .neo-btn:hover {
            transform: translate(-2px, -2px);
            box-shadow: 6px 6px 0px 0px #000000;
        }

        .neo-btn:active {
            transform: translate(2px, 2px);
            box-shadow: 0px 0px 0px 0px #000000;
        }

        .sticker-btn {
            background: #FFFFFF;
            border: 2px solid #eeeeee;
            border-radius: 0.75rem;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .sticker-btn:hover {
            border-color: #000;
            transform: scale(1.05);
            background: #fff;
        }

        .sticker-btn.active {
            background: #FF90E8;
            border: 2px solid #000;
            box-shadow: 2px 2px 0px 0px #000;
            transform: scale(1.1) rotate(-3deg);
        }
        
        .sticker-btn.multi-selected {
            background: linear-gradient(135deg, #A78BFA 0%, #F472B6 100%);
            border: 3px solid #000;
            box-shadow: 3px 3px 0px 0px #000;
            transform: scale(1.05);
            position: relative;
        }
        
        .sticker-btn.multi-selected::after {
            content: 'âœ“';
            position: absolute;
            top: -5px;
            right: -5px;
            background: #000;
            color: #fff;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
            border: 2px solid #fff;
        }

        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 5px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #000;
            border-radius: 5px;
            border: 2px solid #fff;
        }
        
        .custom-sticker-img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            pointer-events: none;
        }

        .tab-btn {
            border-bottom: 3px solid transparent;
            color: #888;
        }
        .tab-btn.active {
            color: #000;
            border-bottom: 3px solid #000;
            background-color: rgba(255, 201, 0, 0.2); 
        }
        
        .reroll-group {
            display: flex;
            gap: 0.5rem;
            padding: 0.5rem;
            background: rgba(255, 255, 255, 0.95);
            border: 2px solid black;
            border-radius: 1rem;
            box-shadow: 4px 4px 0 black;
        }
        
        /* ç§»åŠ¨ç«¯å±…ä¸­ */
        @media (max-width: 1023px) {
            .reroll-group {
                margin-left: auto;
                margin-right: auto;
            }
            
            /* å¼ºåˆ¶éšè—åº•éƒ¨æ°´å¹³æŒ‰é’®ç»„ */
            #rerollControlsDesktop {
                display: none !important;
            }
            
            /* å³ä¾§ç«–ç›´æŒ‰é’®å±‚çº§æå‡ */
            #rerollControls {
                z-index: 80 !important;
            }
        }

        .toggle-checkbox:checked {
            right: 0;
            border-color: #68D391;
        }
        .toggle-checkbox:checked + .toggle-label {
            background-color: #68D391;
        }

        /* --- âš¡ï¸ åŸç”Ÿ CSS åŠ¨ç”»éƒ¨åˆ† (å¼ºåˆ¶ç”Ÿæ•ˆ) --- */
        
        @keyframes scanMove {
            0% { top: -20%; opacity: 0; }
            10% { opacity: 1; }
            90% { opacity: 1; }
            100% { top: 120%; opacity: 0; }
        }

        @keyframes pulseGlow {
            0%, 100% { opacity: 0.3; }
            50% { opacity: 0.6; }
        }

        @keyframes ripple {
            0% { transform: scale(0.8); opacity: 1; }
            100% { transform: scale(2); opacity: 0; }
        }

        @keyframes fadeInUp {
            0% { opacity: 0; transform: translateY(10px) translateX(-50%); }
            100% { opacity: 1; transform: translateY(0) translateX(-50%); }
        }

        .scan-line {
            position: absolute;
            left: 0;
            width: 100%;
            height: 12px; /* åŠ åš */
            background: linear-gradient(to bottom, transparent, #FF90E8, transparent);
            box-shadow: 0 0 20px #FF90E8, 0 0 40px #FF90E8;
            z-index: 60;
            animation: scanMove 1.5s linear infinite; /* é»˜è®¤åŠ¨ç”» */
            pointer-events: none;
        }

        .scan-line.fast {
            animation-duration: 0.8s; /* å¿«é€Ÿæ¨¡å¼ */
        }

        /* æ‰«æç½‘æ ¼èƒŒæ™¯ */
        .scan-grid {
            position: absolute;
            inset: 0;
            background-image: linear-gradient(0deg, transparent 24%, rgba(255, 144, 232, .3) 25%, rgba(255, 144, 232, .3) 26%, transparent 27%, transparent 74%, rgba(255, 144, 232, .3) 75%, rgba(255, 144, 232, .3) 76%, transparent 77%, transparent), linear-gradient(90deg, transparent 24%, rgba(255, 144, 232, .3) 25%, rgba(255, 144, 232, .3) 26%, transparent 27%, transparent 74%, rgba(255, 144, 232, .3) 75%, rgba(255, 144, 232, .3) 76%, transparent 77%, transparent);
            background-size: 50px 50px;
            animation: pulseGlow 2s infinite;
            pointer-events: none;
            z-index: 55;
        }

        .animate-ripple {
            animation: ripple 3s infinite;
        }
        .animate-fade-in-up {
            animation: fadeInUp 0.3s ease-out forwards;
        }
        
        /* å¼¹çª—æ ·å¼ */
        .modal-overlay {
            backdrop-filter: blur(8px);
            animation: fadeIn 0.3s ease-out;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        @keyframes fadeOut {
            from { opacity: 1; }
            to { opacity: 0; }
        }
        
        .modal-content {
            animation: slideUp 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        
        @keyframes slideUp {
            from { 
                opacity: 0;
                transform: translateY(30px) scale(0.95);
            }
            to { 
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }
        
        .step-number {
            background: linear-gradient(135deg, #FFC900 0%, #FF90E8 100%);
        }
    </style>
</head>
<body>

    <!-- æ¿€æ´»ç å¼¹çª— -->
    <div id="activationModal" class="hidden modal-overlay fixed inset-0 z-[60] flex items-center justify-center bg-black/50 p-4">
        <div class="modal-content bg-white rounded-2xl border-3 border-black shadow-[6px_6px_0px_0px_#000] max-w-md w-full p-6 max-h-[90vh] overflow-y-auto">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-xl font-black text-gray-800">å…è´¹å»æ°´å°</h3>
                <button onclick="closeActivationModal()" class="w-8 h-8 bg-black rounded-full flex items-center justify-center hover:scale-110 transition-transform">
                    <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>
            
            <div class="space-y-4">
                <!-- è·å–æ¿€æ´»ç æ–¹å¼ -->
                <div class="bg-gradient-to-r from-pink-100 to-purple-100 p-4 rounded-xl border-2 border-black">
                    <p class="text-sm font-bold text-gray-700 mb-3 flex items-center gap-2">
                        <span>ğŸ’</span>
                        <span>è·å–æ¿€æ´»ç </span>
                    </p>
                    
                    <!-- æ–¹å¼1ï¼šæ·»åŠ å¾®ä¿¡ -->
                    <div class="bg-white p-3 rounded-lg border-2 border-black mb-3">
                        <p class="text-xs font-bold text-gray-700 mb-2">æ–¹å¼1ï¸âƒ£ï¼šæ·»åŠ ç™½è±†å¾®ä¿¡</p>
                        <div class="flex items-center justify-between bg-gray-50 px-3 py-2 rounded">
                            <span class="font-mono font-bold text-pink-600 text-sm">cupaobaidou</span>
                            <button onclick="copyWechatId('cupaobaidou')" class="text-xs bg-black text-white px-2 py-1 rounded hover:bg-gray-800">å¤åˆ¶</button>
                        </div>
                        <div id="copySuccessMsg" class="hidden mt-2 text-center text-xs text-green-600 font-bold animate-pulse">âœ… å¤åˆ¶æˆåŠŸï¼</div>
                    </div>
                    
                    <!-- æ–¹å¼2ï¼šå…³æ³¨å…¬ä¼—å· -->
                    <div class="bg-white p-3 rounded-lg border-2 border-black">
                        <p class="text-xs font-bold text-gray-700 mb-2">æ–¹å¼2ï¸âƒ£ï¼šå…³æ³¨å…¬ä¼—å·ã€Œé†‹æ³¡ç™½è±†ã€</p>
                        <div class="flex items-center gap-3">
                            <div class="flex-1">
                                <p class="text-[10px] text-gray-500 mb-1">æ‰«ç å…³æ³¨åå›å¤</p>
                                <div class="bg-gray-50 px-2 py-1 rounded inline-block">
                                    <span class="font-mono font-bold text-pink-600 text-xs">facejam.cc</span>
                                </div>
                            </div>
                            <div class="w-24 h-24 bg-white border-2 border-gray-300 rounded-lg flex items-center justify-center shrink-0">
                                <img src="https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=https://mp.weixin.qq.com/mp/profile_ext?action=home%26__biz=MzI2OTIxMTg1Nw==" alt="å…¬ä¼—å·äºŒç»´ç " class="w-full h-full object-contain p-1">
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- è¾“å…¥æ¿€æ´»ç  -->
                <div>
                    <label class="block text-sm font-bold text-gray-700 mb-2">è¾“å…¥æ¿€æ´»ç </label>
                    <input 
                        type="text" 
                        id="activationCodeInput"
                        placeholder="è¯·è¾“å…¥æ¿€æ´»ç "
                        class="w-full px-4 py-3 border-2 border-black rounded-xl text-center font-mono font-bold uppercase focus:outline-none focus:border-pink-500 transition-colors"
                        onkeypress="if(event.key==='Enter') submitActivationCode()"
                    />
                    <div id="activationMessage" class="text-sm mt-2 text-center"></div>
                </div>
                
                <button onclick="submitActivationCode()" class="w-full bg-gradient-to-r from-pink-400 to-purple-400 hover:from-pink-500 hover:to-purple-500 text-white font-black py-3 rounded-xl border-3 border-black shadow-[4px_4px_0px_0px_#000] hover:shadow-[6px_6px_0px_0px_#000] hover:translate-x-[-2px] hover:translate-y-[-2px] transition-all">
                    âœ¨ æ¿€æ´»
                </button>
            </div>
        </div>
    </div>

    <!-- æ¬¢è¿å¼¹çª— -->
    <div id="welcomeModal" class="modal-overlay fixed inset-0 z-50 flex items-center justify-center bg-black/40 p-3 sm:p-4 overflow-y-auto">
        <div class="modal-content bg-gradient-to-br from-pink-100 via-purple-50 to-yellow-50 rounded-2xl sm:rounded-3xl border-3 sm:border-4 border-black shadow-[4px_4px_0px_0px_#000] sm:shadow-[8px_8px_0px_0px_#000] max-w-lg w-full my-auto">
            <!-- å¤´éƒ¨ -->
            <div class="bg-gradient-to-r from-pink-400 via-purple-400 to-pink-400 p-3 sm:p-5 rounded-t-xl sm:rounded-t-2xl border-b-3 sm:border-b-4 border-black relative">
                <div class="flex items-center justify-between gap-2">
                    <div class="flex items-center gap-2 sm:gap-3">
                        <span class="text-2xl sm:text-4xl animate-bounce">ğŸ¥°</span>
                        <h2 class="text-lg sm:text-2xl font-black text-white drop-shadow-lg">å—¨ï¼æˆ‘æ˜¯è´´è„¸é…±</h2>
                    </div>
                    <button onclick="closeWelcomeModal()" class="w-8 h-8 sm:w-10 sm:h-10 bg-black rounded-full flex items-center justify-center hover:scale-110 transition-transform shrink-0">
                        <svg class="w-5 h-5 sm:w-6 sm:h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M6 18L18 6M6 6l12 12"></path></svg>
                    </button>
                </div>
            </div>
            
            <!-- å†…å®¹ -->
            <div class="p-5 sm:p-8 space-y-4 sm:space-y-6">
                <!-- ä»‹ç» -->
                <div class="text-center space-y-2 sm:space-y-3">
                    <p class="text-lg sm:text-2xl font-black text-gray-800">å‘æœ‹å‹åœˆä¸æƒ³éœ²è„¸ï¼Ÿ</p>
                    <p class="text-2xl sm:text-3xl font-black text-transparent bg-clip-text bg-gradient-to-r from-pink-500 to-purple-600">AI å¸®ä½ ä¸€é”®è´´è„¸ï¼</p>
                </div>
                
                <!-- éšç§æç¤º -->
                <div class="bg-green-50 border-2 border-green-500 rounded-xl sm:rounded-2xl p-3 sm:p-4 flex items-center gap-2 sm:gap-3">
                    <span class="text-2xl sm:text-3xl shrink-0">ğŸ”’</span>
                    <p class="text-xs sm:text-sm text-green-700 font-bold leading-relaxed">æœ¬åœ°å¤„ç†ï¼Œç…§ç‰‡ä¸ä¸Šä¼ ï¼Œéšç§100%å®‰å…¨</p>
                </div>
                
                <!-- å¼€å§‹æŒ‰é’® -->
                <button onclick="closeWelcomeModal()" class="w-full bg-gradient-to-r from-yellow-400 to-pink-400 hover:from-yellow-500 hover:to-pink-500 text-black font-black text-lg sm:text-xl py-4 sm:py-5 rounded-xl sm:rounded-2xl border-3 sm:border-4 border-black shadow-[4px_4px_0px_0px_#000] sm:shadow-[6px_6px_0px_0px_#000] hover:shadow-[6px_6px_0px_0px_#000] sm:hover:shadow-[8px_8px_0px_0px_#000] hover:translate-x-[-2px] hover:translate-y-[-2px] transition-all flex items-center justify-center gap-2">
                    <span>å¼€å§‹è´´è„¸ï¼</span>
                    <span class="text-2xl sm:text-3xl">ğŸš€</span>
                </button>
            </div>
        </div>
    </div>

    <!-- é¡¶éƒ¨å¯¼èˆª -->
    <header class="bg-white border-b-4 border-black flex-none py-2 sm:py-3 z-30">
        <div class="w-full max-w-[1800px] mx-auto px-4 flex justify-between items-center">
            <div class="flex items-center gap-3">
                <div class="w-8 h-8 sm:w-10 sm:h-10 rounded-lg border-2 border-black bg-[#FF90E8] flex items-center justify-center text-lg sm:text-xl shadow-hard-sm shrink-0">
                    ğŸ¥°
                </div>
                <div class="flex flex-col">
                    <h1 class="text-lg sm:text-xl font-bold text-black tracking-tight leading-none flex items-center gap-2">
                        FaceJam
                        <span class="px-2 py-0.5 bg-gradient-to-r from-pink-400 to-purple-400 text-white text-[10px] sm:text-xs rounded-full transform -rotate-3 shadow-md">âœ¨è´´è„¸é…±âœ¨</span>
                    </h1>
                    <div class="hidden sm:flex items-center gap-1 mt-1 text-xs font-bold text-green-600">
                        <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                        çº¯æœ¬åœ°è¿è¡Œ
                    </div>
                </div>
            </div>
            
            <div class="flex gap-2">
                <button onclick="toggleLanguage()" id="langBtn" class="neo-btn w-9 h-9 hidden sm:flex items-center justify-center bg-white text-sm font-bold" title="Switch Language">
                    <span id="langIcon">EN</span>
                </button>
                <button onclick="downloadImage()" id="downloadBtn" class="neo-btn px-3 py-1.5 flex items-center gap-2 bg-[#23A6D5] text-white text-xs sm:text-sm hidden">
                    <span id="downloadBtnText">ğŸ’¾ ä¿å­˜</span>
                </button>
                <button onclick="triggerUpload()" id="uploadBtn" class="neo-btn px-3 py-1.5 flex items-center gap-2 bg-[#FFC900] text-xs sm:text-sm">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                    <span id="uploadBtnText">ä¸Šä¼ </span>
                </button>
            </div>
        </div>
    </header>

    <main class="flex-1 w-full max-w-[1800px] mx-auto p-2 sm:p-4 flex flex-col lg:flex-row gap-3 sm:gap-6 min-h-0">
        
        <!-- å·¦ä¾§ï¼šç¼–è¾‘ç”»å¸ƒ -->
        <div class="relative order-2 lg:order-1 flex flex-col h-[65%] min-h-[50vh] lg:h-full w-full lg:flex-1">
            <div class="neo-card w-full h-full flex items-center justify-center relative bg-white group overflow-hidden">
                <div class="absolute inset-0 opacity-10 pointer-events-none" style="background-image: linear-gradient(#000 1px, transparent 1px), linear-gradient(90deg, #000 1px, transparent 1px); background-size: 20px 20px;"></div>
                
                <!-- Canvas -->
                <div class="w-full h-full flex items-center justify-center p-2 overflow-hidden">
                    <canvas id="editorCanvas" class="cursor-crosshair shadow-sm block"></canvas>
                </div>
                
                <!-- åˆå§‹ç©ºçŠ¶æ€ -->
                <div id="placeholderText" onclick="triggerUpload()" class="absolute inset-0 z-20 flex flex-col items-center justify-start text-slate-400 cursor-pointer hover:bg-gray-50 transition-colors p-6 pt-16 pb-8">
                    <!-- ä¸Šæ–¹ï¼šä»‹ç»å¡ç‰‡ -->
                    <div class="w-full max-w-md mb-4">
                        <div class="relative bg-gradient-to-br from-pink-100 via-purple-100 to-yellow-100 rounded-3xl p-5 border-4 border-black shadow-[8px_8px_0px_0px_#000] overflow-hidden">
                            <!-- è£…é¥°æ€§å…ƒç´  -->
                            <div class="absolute top-2 right-2 text-4xl opacity-20">ğŸ¨</div>
                            <div class="absolute bottom-2 left-2 text-3xl opacity-20 animate-pulse">âœ¨</div>
                            
                            <!-- ä¸»æ ‡é¢˜ -->
                            <div class="relative z-10 text-center space-y-2">
                                <h2 class="text-xl font-black text-transparent bg-clip-text bg-gradient-to-r from-pink-600 via-purple-600 to-pink-600 leading-tight whitespace-nowrap">
                                    æœ‰è¶£çš„äººåƒè‡ªåŠ¨é©¬èµ›å…‹å·¥å…·
                                </h2>
                                <div class="flex items-center justify-center gap-2">
                                    <span class="text-3xl font-black text-black">è´´è„¸é…±</span>
                                    <span class="text-3xl">ğŸ¥°</span>
                        </div>
                                <p class="text-xs text-gray-600 font-medium mt-2">
                                    AI æ™ºèƒ½è¯†åˆ« Â· ä¸€é”®æ‰“ç  Â· è¶£å‘³æ»¡åˆ†
                                </p>
                    </div>
                        </div>
                    </div>
                    
                    <!-- éšç§æç¤º -->
                    <div class="w-full max-w-md mb-4 flex flex-col items-center gap-1.5 px-4">
                        <div class="flex items-center gap-2 text-xs text-green-600 font-semibold">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path></svg>
                            <span>100%æœ¬åœ°å¤„ç† Â· ç…§ç‰‡ä¸ä¸Šä¼ </span>
                        </div>
                        <p class="text-[10px] text-gray-400 text-center leading-relaxed">
                            æ‰€æœ‰å›¾ç‰‡ä»…åœ¨æ‚¨çš„æµè§ˆå™¨ä¸­å¤„ç†ï¼Œä¸ä¼šä¸Šä¼ åˆ°ä»»ä½•æœåŠ¡å™¨ï¼Œç»å¯¹å®‰å…¨æ”¾å¿ƒï¼
                        </p>
                    </div>
                    
                    <!-- ä¸Šä¼ æŒ‰é’® - å¸¦åŠ¨æ€ç›¸æœºå›¾æ ‡ -->
                    <div class="w-full max-w-sm">
                        <button class="w-full bg-gradient-to-r from-pink-500 to-purple-500 hover:from-pink-600 hover:to-purple-600 text-white font-black text-lg py-3 px-4 rounded-2xl border-4 border-black shadow-[6px_6px_0px_0px_#000] hover:shadow-[8px_8px_0px_0px_#000] hover:translate-x-[-2px] hover:translate-y-[-2px] transition-all flex items-center justify-center gap-3">
                            <!-- åŠ¨æ€ç›¸æœºå›¾æ ‡ -->
                            <div class="relative w-12 h-12 flex items-center justify-center flex-shrink-0">
                                <div class="absolute inset-0 bg-white opacity-30 rounded-full animate-ripple"></div>
                                <div class="absolute inset-1 bg-white opacity-50 rounded-full animate-ripple" style="animation-delay: 0.5s;"></div>
                                <div class="w-10 h-10 bg-white rounded-full flex items-center justify-center border-2 border-black relative z-10">
                                    <span class="text-xl">ğŸ“·</span>
                                </div>
                            </div>
                            <span class="text-lg">ç‚¹å‡»ä¸Šä¼ ç…§ç‰‡</span>
                        </button>
                    </div>
                </div>

                <!-- Loading é®ç½© (å¼ºè§†è§‰åé¦ˆ) -->
                <div id="loadingOverlay" class="hidden absolute inset-0 z-50 bg-black/40 backdrop-blur-[2px] flex flex-col items-center justify-center transition-opacity duration-300">
                    <!-- æ‰«æç½‘æ ¼ -->
                    <div class="scan-grid"></div>
                    
                    <!-- æ¿€å…‰æ‰«æçº¿ -->
                    <div class="relative w-full h-full overflow-hidden absolute inset-0 pointer-events-none">
                        <div id="scanLine" class="scan-line"></div>
                    </div>
                    
                    <div class="absolute inset-0 flex flex-col items-center justify-center pointer-events-none p-4 z-50">
                        <div class="bg-black/80 p-4 rounded-xl border-2 border-white/20 shadow-2xl flex flex-col items-center">
                            <h3 class="font-bold text-white text-xl sm:text-2xl tracking-wider mb-3" id="loadingTitle">æ­£åœ¨æ‰«æ...</h3>
                            <div class="w-48 sm:w-64 h-3 sm:h-4 bg-gray-800 rounded-full overflow-hidden border border-gray-600">
                                <div id="loadingProgress" class="h-full bg-[#FF90E8] w-0 transition-all duration-300 shadow-[0_0_10px_#FF90E8]"></div>
                            </div>
                            <p class="text-xs text-gray-400 mt-2" id="loadingSubtitle">åŠ è½½ AI æ¨¡å‹ä¸­...</p>
                        </div>
                    </div>
                </div>

                <!-- å¾®è°ƒæ‚¬æµ®æ¡ -->
                <div id="floatingToolbar" class="hidden absolute bottom-6 left-0 right-0 mx-auto w-fit bg-white border-2 border-black shadow-hard rounded-full px-3 py-2 flex items-center gap-2 sm:gap-3 z-20 whitespace-nowrap max-w-[95%] overflow-x-auto custom-scrollbar">
                    <span class="text-[10px] sm:text-xs font-bold text-black bg-[#FFC900] px-1.5 py-0.5 rounded border border-black shrink-0">å¤§å°</span>
                    <input type="range" id="sizeSlider" min="20" max="500" value="100" class="w-20 sm:w-32 shrink-0" oninput="updateSelectedSize(this.value)">
                    <div class="w-0.5 h-5 bg-black shrink-0"></div>
                    <button onclick="deleteSelected()" class="text-red-500 hover:text-red-600 transition-colors p-1 shrink-0" title="åˆ é™¤">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                    </button>
                </div>
            </div>
            
            <!-- é‡éšæŒ‰é’® - æ¡Œé¢ç«¯ä¿æŒåœ¨ç…§ç‰‡ä¸Š -->
            <div id="rerollControlsDesktop" class="hidden absolute bottom-4 right-4 sm:bottom-6 sm:right-6 z-30 flex-col items-end gap-2 animate-fade-in-up scale-90 sm:scale-100 origin-bottom-right">
                <div class="bg-black text-white text-[10px] px-2 py-1 rounded mb-1 transform translate-y-1 shadow-md">å†è´´ä¸€æ¬¡ğŸ‘‡</div>
                    <div class="reroll-group">
                        <button onclick="rerollCategory('default')" class="neo-btn w-9 h-9 sm:w-10 sm:h-10 flex items-center justify-center text-lg sm:text-xl bg-[#FFFDF5] hover:bg-[#FF90E8]" title="è¡¨æƒ…">ğŸ˜€</button>
                        <div class="w-px h-5 sm:h-6 bg-gray-300 my-auto"></div>
                        <button onclick="rerollCategory('animals')" class="neo-btn w-9 h-9 sm:w-10 sm:h-10 flex items-center justify-center text-lg sm:text-xl bg-[#FFFDF5] hover:bg-[#FFC900]" title="åŠ¨ç‰©">ğŸ¶</button>
                    <button onclick="rerollCategory('kay')" class="neo-btn w-9 h-9 sm:w-10 sm:h-10 flex items-center justify-center text-lg sm:text-xl bg-[#FFFDF5] hover:bg-gradient-to-br hover:from-pink-300 hover:to-purple-300" title="Kay">ğŸ¨</button>
                        <button onclick="rerollCategory('plants')" class="neo-btn w-9 h-9 sm:w-10 sm:h-10 flex items-center justify-center text-lg sm:text-xl bg-[#FFFDF5] hover:bg-[#4ADE80]" title="æ¤ç‰©">ğŸŒ¿</button>
                        <button onclick="rerollCategory('chaos')" class="neo-btn w-10 h-9 sm:w-12 sm:h-10 flex items-center justify-center text-lg sm:text-xl bg-[#FFFDF5] hover:bg-[#A78BFA]" title="å¤§ä¹±ç‚–">ğŸ¥˜</button>
                        <div class="w-px h-5 sm:h-6 bg-gray-300 my-auto"></div>
                        <button onclick="rerollCategory('custom')" class="neo-btn w-10 h-9 sm:w-12 sm:h-10 flex items-center justify-center text-lg sm:text-xl bg-[#FFFDF5] hover:bg-[#F472B6]" title="æˆ‘çš„">ğŸ“¤</button>
                </div>
            </div>
        </div>

        <!-- å³ä¾§ï¼šå·¥å…·æ  -->
        <div id="stickerSection" class="order-1 lg:order-2 h-[35%] lg:h-full lg:w-[380px] w-full flex flex-col min-h-0 shrink-0 hidden lg:flex">
            <div class="neo-card flex flex-col h-full overflow-hidden bg-white w-full border-r-4 border-black">
                <!-- é€‰é¡¹å¡ -->
                <div class="flex border-b-2 border-black bg-white shrink-0">
                    <button onclick="switchTab('faces')" class="tab-btn active flex-1 py-2 sm:py-3 text-xs sm:text-base font-bold hover:bg-gray-50 transition-colors" id="tab-faces">è¡¨æƒ…</button>
                    <button onclick="switchTab('animals')" class="tab-btn flex-1 py-2 sm:py-3 text-xs sm:text-base font-bold hover:bg-gray-50 transition-colors" id="tab-animals">åŠ¨ç‰©</button>
                    <button onclick="switchTab('kay')" class="tab-btn flex-1 py-2 sm:py-3 text-xs sm:text-base font-bold hover:bg-gray-50 transition-colors" id="tab-kay">Kay</button>
                    <button onclick="switchTab('others')" class="tab-btn flex-1 py-2 sm:py-3 text-xs sm:text-base font-bold hover:bg-gray-50 transition-colors" id="tab-others">å…¶å®ƒ</button>
                    <button onclick="switchTab('custom')" class="tab-btn flex-1 py-2 sm:py-3 text-xs sm:text-base font-bold hover:bg-gray-50 transition-colors" id="tab-custom">è‡ªå®šä¹‰</button>
                </div>

                <!-- æ»šåŠ¨åŒºåŸŸ -->
                <div class="flex-1 overflow-y-auto custom-scrollbar p-3 sm:p-4 bg-[#fafafa] min-h-0">
                    <!-- Multi-select mode toggle - åªåœ¨è¡¨æƒ…ã€åŠ¨ç‰©ã€å…¶å®ƒæ ‡ç­¾æ˜¾ç¤º -->
                    <div id="multiSelectToggleRow" class="mb-3 sm:mb-4 bg-gradient-to-r from-purple-100 to-pink-100 p-3 rounded-xl border-2 border-black shadow-hard-sm">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center gap-2">
                                <span class="text-xl">ğŸ¯</span>
                                <span class="text-xs font-bold">è‡ªé€‰æ¨¡å¼ï¼ˆä»…ç”¨é€‰ä¸­è´´å›¾è´´è„¸ï¼‰</span>
                            </div>
                            <div class="relative inline-block w-10 mr-2 align-middle select-none transition duration-200 ease-in">
                                <input type="checkbox" name="toggle" id="multiSelectToggle" class="toggle-checkbox absolute block w-5 h-5 rounded-full bg-white border-4 appearance-none cursor-pointer"/>
                                <label for="multiSelectToggle" class="toggle-label block overflow-hidden h-5 rounded-full bg-gray-300 cursor-pointer"></label>
                            </div>
                        </div>
                        <div id="multiSelectApplyBtn" class="hidden mt-3 neo-btn py-2 bg-gradient-to-r from-pink-400 to-purple-400 text-white text-center font-bold text-sm hover:from-pink-500 hover:to-purple-500" onclick="applyMultiSelectEmojis()">
                            âœ¨ ä¸€é”®è´´ä¸Š (<span id="multiSelectCount">0</span>ä¸ª)
                        </div>
                    </div>
                    
                    <div id="emojiGrid" class="grid grid-cols-5 sm:grid-cols-6 gap-2 sm:gap-3 content-start pb-10"></div>
                    
                    <!-- Kayä¸“åŒº -->
                    <div id="kaySection" class="hidden space-y-3 sm:space-y-4 pb-10">
                        <!-- Kayä»‹ç»å¡ç‰‡ -->
                        <div class="bg-gradient-to-r from-pink-100 to-purple-100 border-2 border-black rounded-xl p-3 sm:p-4 shadow-hard-sm">
                            <div class="flex items-start gap-3">
                                <div class="w-12 h-12 sm:w-16 sm:h-16 bg-gradient-to-br from-pink-400 to-purple-400 rounded-full flex items-center justify-center text-2xl sm:text-3xl border-2 border-black shrink-0">
                                    ğŸ¨
                                </div>
                                <div class="flex-1 min-w-0">
                                    <h3 class="text-sm sm:text-base font-black text-gray-800 mb-1">æ’ç”»å¸ˆKayçš„åŸåˆ›è´´çº¸</h3>
                                    <p class="text-xs text-gray-600 mb-2">å¯çˆ±çš„å›¢å­å’Œå°åŠ¨ç‰©ï¼Œè®©ä½ çš„ç…§ç‰‡æ›´æœ‰è¶£ï¼</p>
                                    <a href="https://www.xiaohongshu.com/user/profile/53171ac1b4c4d6226fdcf19a" target="_blank" class="inline-flex items-center gap-1 text-xs font-bold text-pink-600 hover:text-pink-700 bg-white px-2 py-1 rounded-full border border-pink-300 hover:border-pink-500 transition-all">
                                        <span>âœ¨</span>
                                        <span>è®¿é—®Kayçš„å°çº¢ä¹¦ä¸»é¡µ</span>
                                        <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path></svg>
                                    </a>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Kayçš„è´´çº¸ç½‘æ ¼ -->
                        <div id="kayStickers" class="grid grid-cols-4 sm:grid-cols-5 gap-2 sm:gap-3"></div>
                    </div>
                    
                    <!-- è‡ªå®šä¹‰åŒºåŸŸ -->
                    <div id="customSection" class="hidden space-y-3 sm:space-y-4 pb-10">
                        <div class="flex items-center justify-between bg-white p-2 rounded-lg border-2 border-gray-200">
                            <div class="flex items-center gap-2">
                                <span class="text-lg">ğŸª„</span>
                                <div class="flex flex-col">
                                    <span class="text-xs font-bold">è‡ªåŠ¨æ™ºèƒ½å»åº•</span>
                                    <span class="text-[10px] text-gray-400 font-medium">ä»…é™çº¯è‰²(ç™½/é»‘)èƒŒæ™¯</span>
                                </div>
                            </div>
                            <div class="relative inline-block w-10 mr-2 align-middle select-none transition duration-200 ease-in">
                                <input type="checkbox" name="toggle" id="bgRemoveToggle" class="toggle-checkbox absolute block w-5 h-5 rounded-full bg-white border-4 appearance-none cursor-pointer" checked/>
                                <label for="bgRemoveToggle" class="toggle-label block overflow-hidden h-5 rounded-full bg-gray-300 cursor-pointer"></label>
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-2 sm:gap-3 mb-2">
                            <button onclick="document.getElementById('customFileUpload').click()" class="neo-btn py-2 sm:py-3 flex flex-col items-center justify-center gap-1 bg-[#FF90E8] text-white hover:bg-[#FFC900]">
                                <span class="text-lg sm:text-xl">ğŸ“‚</span>
                                <span class="text-[10px] sm:text-xs">ä¸Šä¼ æœ¬åœ°å›¾</span>
                            </button>
                            <button onclick="promptForCustomSticker()" class="neo-btn py-2 sm:py-3 flex flex-col items-center justify-center gap-1 bg-[#23A6D5] text-white hover:bg-[#FFC900]">
                                <span class="text-lg sm:text-xl">ğŸ”—</span>
                                <span class="text-[10px] sm:text-xs">è´´é“¾æ¥</span>
                            </button>
                        </div>
                        <div class="grid grid-cols-4 gap-2 sm:gap-3" id="customStickerContainer"></div>
                    </div>
                </div>
                
                <!-- åº•éƒ¨çŠ¶æ€æ  - å…¨ç«¯æ˜¾ç¤º -->
                <div class="flex p-2 sm:p-3 bg-black text-white text-[10px] sm:text-xs font-bold justify-between items-center shrink-0">
                    <div class="flex items-center gap-1 sm:gap-2 min-w-0">
                        <span class="w-2 h-2 rounded-full bg-yellow-500 flex-shrink-0" id="aiStatusDot"></span>
                        <span id="aiStatusText" class="truncate">AI å‡†å¤‡ä¸­...</span>
                        <button id="aiRetryBtn" onclick="retryLoadModels()" class="hidden ml-1 bg-red-600 hover:bg-red-700 px-2 py-0.5 rounded text-[9px] sm:text-[10px] transition-all flex-shrink-0" title="é‡æ–°åŠ è½½AIæ¨¡å‹">
                            ğŸ”„ é‡è¯•
                        </button>
                    </div>
                    <div class="flex items-center gap-2">
                        <button onclick="showActivationModal()" id="watermarkBtn" class="bg-gradient-to-r from-pink-500 to-purple-500 hover:from-pink-600 hover:to-purple-600 text-white px-2 sm:px-3 py-1 rounded-full transition-all text-[10px] sm:text-xs font-bold">
                            <span id="watermarkBtnText">ğŸ¨ å…è´¹å»æ°´å°</span>
                        </button>
                    <span id="maskCount" class="bg-white text-black px-2 py-0.5 rounded-full">0 é®æŒ¡</span>
                    </div>
                </div>
            </div>
            <input type="file" id="imageUpload" accept="image/*" class="hidden" onclick="this.value=null" onchange="handleImageUpload(event)" />
            <input type="file" id="customFileUpload" accept="image/*" multiple class="hidden" onclick="this.value=null" onchange="handleCustomFileUpload(event)" />
        </div>
    </main>

    <!-- ç§»åŠ¨ç«¯å³ä¾§ç«–ç›´æŒ‰é’® - å®Œå…¨è´´è¾¹ + å¯æŠ˜å  -->
    <div id="rerollControls" class="hidden lg:hidden fixed right-0 z-40 flex flex-col gap-1 animate-fade-in-up transition-transform duration-300" style="bottom: max(1rem, calc(env(safe-area-inset-bottom) + 1rem));">
        <!-- æŠ˜å /å±•å¼€æŒ‰é’® -->
        <button onclick="toggleRerollControls()" id="rerollToggleBtn" class="neo-btn w-12 h-10 flex items-center justify-center text-lg bg-gradient-to-r from-pink-500 to-purple-500 text-white hover:from-pink-600 hover:to-purple-600 active:scale-95 transition-all shadow-md rounded-l-2xl border-r-0 font-bold" title="æŠ˜å /å±•å¼€">
            <span id="rerollToggleIcon">â—€</span>
        </button>
        
        <!-- æŒ‰é’®ç»„ -->
        <div id="rerollButtonGroup" class="flex flex-col gap-1">
            <div class="bg-black text-white text-[8px] px-1 py-0.5 rounded-l whitespace-nowrap shadow-md">å†è´´ä¸€æ¬¡ğŸ‘‡</div>
            <button onclick="rerollCategory('default')" class="neo-btn w-12 h-12 flex items-center justify-center text-xl bg-white hover:bg-[#FF90E8] active:scale-95 transition-all shadow-md rounded-l-2xl border-r-0" title="è¡¨æƒ…">ğŸ˜€</button>
            <button onclick="rerollCategory('animals')" class="neo-btn w-12 h-12 flex items-center justify-center text-xl bg-white hover:bg-[#FFC900] active:scale-95 transition-all shadow-md rounded-l-2xl border-r-0" title="åŠ¨ç‰©">ğŸ¶</button>
            <button onclick="rerollCategory('kay')" class="neo-btn w-12 h-12 flex items-center justify-center text-xl bg-white hover:bg-gradient-to-br hover:from-pink-300 hover:to-purple-300 active:scale-95 transition-all shadow-md rounded-l-2xl border-r-0" title="Kay">ğŸ¨</button>
            <button onclick="rerollCategory('plants')" class="neo-btn w-12 h-12 flex items-center justify-center text-xl bg-white hover:bg-[#4ADE80] active:scale-95 transition-all shadow-md rounded-l-2xl border-r-0" title="æ¤ç‰©">ğŸŒ¿</button>
            <button onclick="rerollCategory('chaos')" class="neo-btn w-12 h-12 flex items-center justify-center text-xl bg-white hover:bg-[#A78BFA] active:scale-95 transition-all shadow-md rounded-l-2xl border-r-0" title="å¤§ä¹±ç‚–">ğŸ¥˜</button>
            <button onclick="rerollCategory('custom')" class="neo-btn w-12 h-12 flex items-center justify-center text-xl bg-white hover:bg-[#F472B6] active:scale-95 transition-all shadow-md rounded-l-2xl border-r-0" title="æˆ‘çš„">ğŸ“¤</button>
        </div>
    </div>

    <script>
        // æ•°æ®
        const EMOJI_DB = {
            faces: ['ğŸ˜', 'ğŸ¥°', 'ğŸ˜', 'ğŸ˜˜', 'ğŸ¤ª', 'ğŸ˜†', 'ğŸ¤£', 'ğŸ˜‚', 'ğŸ˜', 'ğŸ˜Š', 'ğŸ˜‡', 'ğŸ¤©', 'ğŸ¥³', 'ğŸ¤—', 'ğŸ˜‹', 'ğŸ˜›', 'ğŸ˜', 'ğŸ˜œ', 'ğŸ¤“', 'ğŸ¤ ', 'ğŸ‘»', 'ğŸ‘½', 'ğŸ‘¾', 'ğŸ¤–', 'ğŸƒ', 'ğŸ˜º', 'ğŸ˜¸', 'ğŸ˜¹', 'ğŸ˜»', 'ğŸ˜¼', 'ğŸ˜½', 'ğŸ¤”', 'ğŸ¤«', 'ğŸ¤­', 'ğŸ¤¥', 'ğŸ˜¶', 'ğŸ˜', 'ğŸ˜‘', 'ğŸ˜¬', 'ğŸ™„', 'ğŸ˜¯', 'ğŸ˜¦', 'ğŸ˜§', 'ğŸ˜®', 'ğŸ˜²', 'ğŸ¥±', 'ğŸ˜´', 'ğŸ˜ª', 'ğŸ¤', 'ğŸ¥´', 'ğŸ¤§', 'ğŸ˜·', 'ğŸ¤’', 'ğŸ¤•', 'ğŸ¤‘', 'ğŸ¥º', 'ğŸ˜¢', 'ğŸ˜­', 'ğŸ˜¤', 'ğŸ˜ ', 'ğŸ˜¡', 'ğŸ¤¬', 'ğŸ¤¯', 'ğŸ˜³', 'ğŸ¥µ', 'ğŸ¥¶', 'ğŸ˜±', 'ğŸ˜¨', 'ğŸ˜°', 'ğŸ˜¥', 'ğŸ˜“'],
            animals: ['ğŸ¶', 'ğŸ±', 'ğŸ­', 'ğŸ¹', 'ğŸ°', 'ğŸ¦Š', 'ğŸ»', 'ğŸ¼', 'ğŸ¨', 'ğŸ¯', 'ğŸ¦', 'ğŸ®', 'ğŸ·', 'ğŸ½', 'ğŸ¸', 'ğŸµ', 'ğŸ™ˆ', 'ğŸ™‰', 'ğŸ™Š', 'ğŸ”', 'ğŸ§', 'ğŸ¦', 'ğŸ¤', 'ğŸ£', 'ğŸ¥', 'ğŸ¦‰', 'ğŸº', 'ğŸ—', 'ğŸ¦„', 'ğŸ¦', 'ğŸ¦§', 'ğŸ¦›'],
            plants: ['ğŸ„', 'ğŸƒ', 'ğŸ’', 'ğŸŒ·', 'ğŸŒ¹', 'ğŸŒº', 'ğŸŒ¸', 'ğŸŒ¼', 'ğŸŒ»', 'ğŸ€', 'ğŸ', 'ğŸƒ', 'ğŸª´', 'ğŸŒ°', 'ğŸŒš', 'ğŸŒ', 'ğŸŒ', 'ğŸŒŸ', 'âœ¨'],
            others: ['â¤ï¸', 'ğŸ§¡', 'ğŸ’›', 'ğŸ’š', 'ğŸ’™', 'ğŸ’œ', 'ğŸ–¤', 'ğŸ¤', 'ğŸ¤', 'ğŸ’”', 'â£ï¸', 'ğŸ’•', 'ğŸ’', 'ğŸ’“', 'ğŸ’—', 'ğŸ’–', 'ğŸ’˜', 'ğŸ’', 'ğŸ’Ÿ', 'ğŸ’£', 'ğŸ’¥', 'ğŸ’¢', 'ğŸ’¤', 'ğŸ’©', 'ğŸ”¥', 'âœ¨', 'ğŸŒŸ', 'âš½', 'ğŸ€', 'ğŸˆ', 'âš¾', 'ğŸ¥', 'ğŸ¾', 'ğŸ', 'ğŸ‰', 'ğŸ±', 'ğŸ”®', 'ğŸ§¿', 'ğŸ©', 'ğŸª', 'ğŸ”', 'ğŸ•', 'ğŸ™', 'ğŸ˜', 'ğŸ£', 'ğŸ‚', 'ğŸ§', 'ğŸ¥§'],
            kay: [
                {name: 'kay_happy.png', title: 'å¼€å¿ƒå›¢å­'},
                {name: 'kay_smug.png', title: 'å‚²å¨‡å›¢å­'},
                {name: 'kay_sweat.png', title: 'æµæ±—é¸­'},
                {name: 'kay_elephant.png', title: 'å¤§è±¡'}
            ]
        };
        const AI_EMOTION_MAP = {
            neutral: ['ğŸ˜', 'ğŸ˜', 'ğŸ˜¶', 'ğŸ˜¶â€ğŸŒ«ï¸', 'ğŸ¸', 'ğŸ¤–', 'ğŸŒ', 'ğŸŒš', 'ğŸ—¿', 'ğŸ±', 'ğŸ¼', 'ğŸ¤”'],
            happy: ['ğŸ˜„', 'ğŸ˜ƒ', 'ğŸ˜€', 'ğŸ˜', 'ğŸ˜†', 'ğŸ˜…', 'ğŸ¤£', 'ğŸ˜‚', 'ğŸ˜Š', 'ğŸ˜‡', 'ğŸ¥°', 'ğŸ˜', 'ğŸ¤©', 'ğŸ¤ª', 'ğŸ¥³', 'ğŸ¤—', 'ğŸ˜‹'],
            sad: ['ğŸ˜”', 'ğŸ˜ª', 'ğŸ¤¤', 'ğŸ˜´', 'ğŸ˜·', 'ğŸ¤’', 'ğŸ¤¥', 'ğŸ¤•', 'ğŸ¥º', 'ğŸ˜¢', 'ğŸ˜­', 'ğŸ˜¿', 'ğŸ¥€'],
            angry: ['ğŸ˜¤', 'ğŸ˜ ', 'ğŸ˜¡', 'ğŸ¤¬', 'ğŸ˜ˆ', 'ğŸ‘¿', 'ğŸ‘º', 'ğŸ’¢', 'ğŸ—¯', 'ğŸ˜’', 'ğŸ™„'],
            fearful: ['ğŸ˜¨', 'ğŸ˜°', 'ğŸ˜¥', 'ğŸ˜“', 'ğŸ¤—', 'ğŸ¥¶', 'ğŸ˜±', 'ğŸ˜–', 'ğŸ˜£', 'ğŸ˜¬', 'ğŸ«£', 'ğŸ™€'],
            disgusted: ['ğŸ¤¢', 'ğŸ¥´', 'ğŸ˜µ', 'ğŸ¤¯', 'ğŸ˜·', 'ğŸ¤§', 'ğŸ˜£', 'ğŸ˜–'],
            surprised: ['ğŸ˜®', 'ğŸ˜¯', 'ğŸ˜²', 'ğŸ˜³', 'ğŸ¥º', 'ğŸ˜¦', 'ğŸ˜§', 'ğŸ¤¯', 'ğŸ˜±', 'ğŸ™€', 'ğŸ¤©']
        };

        const state = {
            isModelLoaded: false,
            manualTool: { type: 'emoji', content: 'ğŸ˜' },
            masks: [], 
            rawDetections: [],
            selectedMaskIndex: -1,
            isDragging: false,
            isResizing: false, 
            dragStartIndex: -1,
            dragOffset: { x: 0, y: 0 },
            img: null,
            scale: 1,
            loadedStickerImages: {},
            customStickers: [], 
            canvasOffset: { left: 0, top: 0 },
            activeTab: 'faces',
            scanTimeout: null,
            dpr: window.devicePixelRatio || 1,
            multiSelectMode: false,
            selectedEmojis: [],
            language: 'zh', // 'zh' or 'en'
            watermarkRemoved: false // æ˜¯å¦å·²å»é™¤æ°´å°
        };
        
        // æ¿€æ´»ç ç³»ç»Ÿ
        const ACTIVATION_CODES = {
            // ä¸‡èƒ½ä»£ç ï¼ˆæ— é™æ¬¡ä½¿ç”¨ï¼‰
            'cupaobaidou': { uses: Infinity, used: 0 },
            'baidou.work': { uses: Infinity, used: 0 },
            'kaykay': { uses: Infinity, used: 0 },
            // 100ä¸ªæ™®é€šä»£ç ï¼ˆæ¯ä¸ª2æ¬¡ï¼‰
            'FJ8K2M': { uses: 2, used: 0 }, 'P3N7XQ': { uses: 2, used: 0 }, 'R9W4TS': { uses: 2, used: 0 },
            'H5V6JL': { uses: 2, used: 0 }, 'Y2B8CK': { uses: 2, used: 0 }, 'M7D3FG': { uses: 2, used: 0 },
            'Q4X9NH': { uses: 2, used: 0 }, 'Z6T2PW': { uses: 2, used: 0 }, 'L8K5RY': { uses: 2, used: 0 },
            'A3S7VM': { uses: 2, used: 0 }, 'E9C4BN': { uses: 2, used: 0 }, 'G2F6HX': { uses: 2, used: 0 },
            'J5W8DQ': { uses: 2, used: 0 }, 'U7P3LK': { uses: 2, used: 0 }, 'N4R9TM': { uses: 2, used: 0 },
            'V8X2SY': { uses: 2, used: 0 }, 'B6M5CW': { uses: 2, used: 0 }, 'K3Q7FH': { uses: 2, used: 0 },
            'T9L4NP': { uses: 2, used: 0 }, 'W2D8RX': { uses: 2, used: 0 }, 'C7V5JK': { uses: 2, used: 0 },
            'F4H9BM': { uses: 2, used: 0 }, 'S6P2QN': { uses: 2, used: 0 }, 'X8T3LW': { uses: 2, used: 0 },
            'D5K7RY': { uses: 2, used: 0 }, 'G9M4VH': { uses: 2, used: 0 }, 'L2W6CX': { uses: 2, used: 0 },
            'Q7N3FS': { uses: 2, used: 0 }, 'R4B8JP': { uses: 2, used: 0 }, 'Y6H2TK': { uses: 2, used: 0 },
            'M9X5DW': { uses: 2, used: 0 }, 'P3L7NQ': { uses: 2, used: 0 }, 'V8C4RM': { uses: 2, used: 0 },
            'H2F9KY': { uses: 2, used: 0 }, 'K6S3BX': { uses: 2, used: 0 }, 'T4W7LH': { uses: 2, used: 0 },
            'N9P2VJ': { uses: 2, used: 0 }, 'J5R8MQ': { uses: 2, used: 0 }, 'B7D3CW': { uses: 2, used: 0 },
            'F2X6NK': { uses: 2, used: 0 }, 'W9H4TS': { uses: 2, used: 0 }, 'L5Q8PY': { uses: 2, used: 0 },
            'C3K7RX': { uses: 2, used: 0 }, 'G6N2VM': { uses: 2, used: 0 }, 'S8B4FH': { uses: 2, used: 0 },
            'X4M9LW': { uses: 2, used: 0 }, 'D7T2QJ': { uses: 2, used: 0 }, 'R3V6KP': { uses: 2, used: 0 },
            'Y9C5HN': { uses: 2, used: 0 }, 'P2W8BX': { uses: 2, used: 0 }, 'K6F3RM': { uses: 2, used: 0 },
            'M4L7SY': { uses: 2, used: 0 }, 'H8J2TQ': { uses: 2, used: 0 }, 'N5X9VW': { uses: 2, used: 0 },
            'Q7B3CK': { uses: 2, used: 0 }, 'T2P6DH': { uses: 2, used: 0 }, 'V9R4NL': { uses: 2, used: 0 },
            'J6K8FM': { uses: 2, used: 0 }, 'W3S5XY': { uses: 2, used: 0 }, 'L7C2BP': { uses: 2, used: 0 },
            'F4H9QW': { uses: 2, used: 0 }, 'B8N3TK': { uses: 2, used: 0 }, 'G2M7RJ': { uses: 2, used: 0 },
            'X6V4LH': { uses: 2, used: 0 }, 'D9P5CY': { uses: 2, used: 0 }, 'R3W8NX': { uses: 2, used: 0 },
            'K7F2VM': { uses: 2, used: 0 }, 'S4Q9BH': { uses: 2, used: 0 }, 'Y6T3JW': { uses: 2, used: 0 },
            'M2L8KP': { uses: 2, used: 0 }, 'H9X5DN': { uses: 2, used: 0 }, 'N4C7RQ': { uses: 2, used: 0 },
            'P8B2VY': { uses: 2, used: 0 }, 'T5W9FX': { uses: 2, used: 0 }, 'J3K6LM': { uses: 2, used: 0 },
            'V7S4NH': { uses: 2, used: 0 }, 'W2R8QK': { uses: 2, used: 0 }, 'C6M3BJ': { uses: 2, used: 0 },
            'F9P5TY': { uses: 2, used: 0 }, 'L4H7XW': { uses: 2, used: 0 }, 'G8N2VC': { uses: 2, used: 0 },
            'Q3D6RM': { uses: 2, used: 0 }, 'X7K9FP': { uses: 2, used: 0 }, 'B5T2LH': { uses: 2, used: 0 },
            'R9V4WN': { uses: 2, used: 0 }, 'Y3S8JQ': { uses: 2, used: 0 }, 'M6C2KX': { uses: 2, used: 0 },
            'K4P7BY': { uses: 2, used: 0 }, 'H8F3NW': { uses: 2, used: 0 }, 'N2X9TM': { uses: 2, used: 0 },
            'T6L5RH': { uses: 2, used: 0 }, 'J9W4VK': { uses: 2, used: 0 }, 'V3B7CQ': { uses: 2, used: 0 },
            'D8S2PX': { uses: 2, used: 0 }, 'W5M9FL': { uses: 2, used: 0 }, 'C4R6NY': { uses: 2, used: 0 },
            'F7H3JW': { uses: 2, used: 0 }, 'L9K2TQ': { uses: 2, used: 0 }, 'G5X8BM': { uses: 2, used: 0 },
            'P2V6RH': { uses: 2, used: 0 }, 'Q8N4CK': { uses: 2, used: 0 }, 'X3W7LS': { uses: 2, used: 0 }
        };
        
        // è¯­è¨€åŒ…
        const i18n = {
            zh: {
                title: 'è´´è„¸é…±',
                localOnly: 'çº¯æœ¬åœ°è¿è¡Œ',
                download: 'ğŸ’¾ ä¿å­˜',
                upload: 'ä¸Šä¼ ',
                changePhoto: 'æ¢å¼ ',
                tabFaces: 'è¡¨æƒ…',
                tabAnimals: 'åŠ¨ç‰©',
                tabKay: 'Kay',
                tabOthers: 'å…¶å®ƒ',
                tabCustom: 'è‡ªå®šä¹‰',
                aiReady: 'AI å°±ç»ª',
                aiPreparing: 'AI å‡†å¤‡ä¸­...',
                aiOffline: 'AI ç¦»çº¿',
                maskCount: 'é®æŒ¡',
                placeholderTitle: 'ç‚¹å‡»ä¸Šä¼ ç…§ç‰‡',
                placeholderSubtitle: 'AI è‡ªåŠ¨è¯†åˆ«',
                privacyTitle: '100%æœ¬åœ°å¤„ç† Â· ç…§ç‰‡ä¸ä¸Šä¼ ',
                privacyDesc: 'æ‰€æœ‰å›¾ç‰‡ä»…åœ¨æ‚¨çš„æµè§ˆå™¨ä¸­å¤„ç†ï¼Œä¸ä¼šä¸Šä¼ åˆ°ä»»ä½•æœåŠ¡å™¨ï¼Œç»å¯¹å®‰å…¨æ”¾å¿ƒï¼',
                loadingScanning: 'æ­£åœ¨æ‰«æ...',
                loadingApplying: 'æ­£åœ¨è´´ä¸Š...',
                loadingSubtitle: 'åŠ è½½ AI æ¨¡å‹ä¸­...',
                rerollLabel: 'å†è´´ä¸€æ¬¡ğŸ‘‡',
                sizeLabel: 'å¤§å°',
                multiSelectTitle: 'è‡ªé€‰æ¨¡å¼',
                multiSelectDesc: 'é€‰å¤šä¸ªemojiæ‰¹é‡è´´è„¸',
                multiSelectApply: 'âœ¨ ä¸€é”®è´´ä¸Š',
                bgRemoveTitle: 'è‡ªåŠ¨æ™ºèƒ½å»åº•',
                bgRemoveDesc: 'ä»…é™çº¯è‰²(ç™½/é»‘)èƒŒæ™¯',
                uploadLocal: 'ä¸Šä¼ æœ¬åœ°å›¾',
                pasteLink: 'è´´é“¾æ¥',
                // æ¬¢è¿å¼¹çª—
                welcomeTitle: 'å—¨ï¼æˆ‘æ˜¯è´´è„¸é…±',
                welcomeIntro1: 'å‘æœ‹å‹åœˆä¸æƒ³éœ²è„¸ï¼Ÿé©¬èµ›å…‹å¤ªä¸‘ï¼Ÿ',
                welcomeIntro2: 'æŠŠç…§ç‰‡äº¤ç»™æˆ‘ï¼ŒAI å¸®ä½ ä¸€é”®"è´´"å¥½ï¼',
                welcomeStep1Title: 'ä¸Šä¼ ç…§ç‰‡',
                welcomeStep1Desc: 'ç‚¹å‡»ç›¸æœºï¼Œæ”¯æŒæ‹–æ‹½ã€‚AI ä¼šè‡ªåŠ¨æ‰¾åˆ°æ‰€æœ‰äººè„¸ã€‚',
                welcomeStep2Title: 'éšæœºè´´è„¸',
                welcomeStep2Desc: 'ä¸ä»…æœ‰ Emojiï¼Œè¿˜æœ‰çŒ«çŒ«ç‹—ç‹—ã€‚ä¸å–œæ¬¢ï¼Ÿç‚¹"å†è´´ä¸€æ¬¡"é‡éšã€‚',
                welcomeStep3Title: 'è‡ªå®šä¹‰ + ä¿å­˜',
                welcomeStep3Desc: 'ä¸Šä¼ ä½ è‡ªå·±çš„è¡¨æƒ…åŒ…ï¼Œç”šè‡³èƒ½è‡ªåŠ¨å»åº•ï¼æ»¡æ„å°±ä¿å­˜ã€‚',
                welcomePrivacyTitle: 'ç»å¯¹éšç§æ‰¿è¯ºï¼š',
                welcomePrivacyDesc: 'è¿™æ˜¯ä¸€ä¸ªçº¯ç½‘é¡µå·¥å…·ï¼Œæ‰€æœ‰è®¡ç®—éƒ½åœ¨ä½ çš„è®¾å¤‡ä¸Šå®Œæˆï¼Œç…§ç‰‡ç»ä¸ä¼šä¸Šä¼ åˆ°ä»»ä½•æœåŠ¡å™¨ï¼Œæ–­ç½‘ä¹Ÿèƒ½ç”¨ï¼',
                welcomeStartBtn: 'å¼€å§‹è´´è„¸ï¼'
            },
            en: {
                title: 'FaceJam',
                localOnly: 'Local Only',
                download: 'ğŸ’¾ Save',
                upload: 'Upload',
                changePhoto: 'Change',
                tabFaces: 'Faces',
                tabAnimals: 'Animals',
                tabKay: 'Kay',
                tabOthers: 'Others',
                tabCustom: 'Custom',
                aiReady: 'AI Ready',
                aiPreparing: 'AI Loading...',
                aiOffline: 'AI Offline',
                maskCount: 'Masks',
                placeholderTitle: 'Click to Upload Photo',
                placeholderSubtitle: 'AI Auto Detect',
                privacyTitle: '100% Local Â· No Upload',
                privacyDesc: 'All images processed in your browser only. Nothing uploaded. Safe & Secure!',
                loadingScanning: 'Scanning...',
                loadingApplying: 'Applying...',
                loadingSubtitle: 'Loading AI Models...',
                rerollLabel: 'Try AgainğŸ‘‡',
                sizeLabel: 'Size',
                multiSelectTitle: 'Multi-Select',
                multiSelectDesc: 'Select multiple emojis',
                multiSelectApply: 'âœ¨ Apply All',
                bgRemoveTitle: 'Auto Remove BG',
                bgRemoveDesc: 'For solid backgrounds only',
                uploadLocal: 'Upload Image',
                pasteLink: 'Paste URL',
                // Welcome modal
                welcomeTitle: 'Hi! I\'m FaceJam',
                welcomeIntro1: 'Want privacy in photos? Mosaic too ugly?',
                welcomeIntro2: 'Let AI help you cover faces with fun stickers!',
                welcomeStep1Title: 'Upload Photo',
                welcomeStep1Desc: 'Click camera or drag & drop. AI finds all faces automatically.',
                welcomeStep2Title: 'Random Stickers',
                welcomeStep2Desc: 'Emojis, cats, dogs & more. Don\'t like it? Try again!',
                welcomeStep3Title: 'Customize & Save',
                welcomeStep3Desc: 'Upload your own stickers, auto remove background! Save when satisfied.',
                welcomePrivacyTitle: 'Privacy Promise:',
                welcomePrivacyDesc: 'Pure web tool. All processing happens on your device. Nothing uploaded. Works offline!',
                welcomeStartBtn: 'Start Now!'
            }
        };

        const canvas = document.getElementById('editorCanvas');
        const ctx = canvas.getContext('2d');
        
        // æ¨¡å‹URLé…ç½®ï¼šæ”¯æŒæœ¬åœ°å’ŒCDNåŒæ¨¡å¼
        // éƒ¨ç½²åˆ°CloudFlareæˆ–ä¸ƒç‰›äº‘æ—¶ï¼Œå¯ä»¥ä¿®æ”¹è¿™ä¸ªURLæŒ‡å‘ä½ çš„CDNåœ°å€
        const MODEL_URL_CDN = 'YOUR_CDN_URL/models'; // æ›¿æ¢æˆä½ çš„CDNåœ°å€
        const MODEL_URL_GITHUB = 'https://justadudewhohacks.github.io/face-api.js/models';
        const MODEL_URL_LOCAL = './models'; // æœ¬åœ°æ¨¡å‹è·¯å¾„
        
        // ä¼˜å…ˆä½¿ç”¨æœ¬åœ°ï¼Œå¦‚æœæœ¬åœ°åŠ è½½å¤±è´¥åˆ™ä½¿ç”¨GitHub CDN
        let MODEL_URL = MODEL_URL_LOCAL;

        // ======================================
        // Google Analytics äº‹ä»¶è¿½è¸ª
        // ======================================
        function trackEvent(eventName, eventParams = {}) {
            if (typeof gtag !== 'undefined') {
                gtag('event', eventName, eventParams);
            }
        }
        
        // ======================================
        // å¤åˆ¶å¾®ä¿¡å·åŠŸèƒ½
        // ======================================
        function copyWechatId(wechatId) {
            navigator.clipboard.writeText(wechatId).then(() => {
                const msg = document.getElementById('copySuccessMsg');
                msg.classList.remove('hidden');
                setTimeout(() => {
                    msg.classList.add('hidden');
                }, 2000);
            }).catch(err => {
                console.error('å¤åˆ¶å¤±è´¥:', err);
                alert('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶ï¼š' + wechatId);
            });
        }
        
        // ======================================
        // æŠ˜å /å±•å¼€"å†è´´ä¸€æ¬¡"æŒ‰é’®ç»„
        // ======================================
        let rerollControlsCollapsed = false;
        
        function toggleRerollControls() {
            const controls = document.getElementById('rerollControls');
            const buttonGroup = document.getElementById('rerollButtonGroup');
            const icon = document.getElementById('rerollToggleIcon');
            
            rerollControlsCollapsed = !rerollControlsCollapsed;
            
            if (rerollControlsCollapsed) {
                // æŠ˜å ï¼šéšè—æŒ‰é’®ç»„ï¼Œå‘å³ç§»åŠ¨
                buttonGroup.style.display = 'none';
                controls.style.transform = 'translateX(0)';
                icon.innerText = 'â–¶';
            } else {
                // å±•å¼€ï¼šæ˜¾ç¤ºæŒ‰é’®ç»„
                buttonGroup.style.display = 'flex';
                controls.style.transform = 'translateX(0)';
                icon.innerText = 'â—€';
            }
        }

        // æ ¸å¿ƒåˆå§‹åŒ–
        async function init() {
            renderEmojiGrid('faces');
            loadCustomStickersFromStorage(); // åŠ è½½è‡ªå®šä¹‰è´´çº¸
            
            const statusDot = document.getElementById('aiStatusDot');
            const statusText = document.getElementById('aiStatusText');
            const retryBtn = document.getElementById('aiRetryBtn');
            
            try {
                statusDot.className = 'w-2 h-2 rounded-full bg-yellow-500 flex-shrink-0 animate-pulse';
                statusText.innerText = 'ğŸ¤– AI åŠ è½½ä¸­...';
                
                // å°è¯•åŠ è½½æ¨¡å‹
                await loadModels();
                state.isModelLoaded = true;
                console.log("Models loaded from:", MODEL_URL);
                
                statusDot.className = 'w-2 h-2 rounded-full bg-green-500 flex-shrink-0';
                statusText.innerText = 'âœ… ' + i18n[state.language].aiReady;
                retryBtn.classList.add('hidden');
                
                // AIå°±ç»ªåï¼Œå¦‚æœå·²æœ‰å›¾ç‰‡ï¼Œè‡ªåŠ¨å¼€å§‹æ£€æµ‹
                if (state.img && state.masks.length === 0) {
                    console.log("AIå°±ç»ªï¼Œè‡ªåŠ¨å¼€å§‹æ£€æµ‹äººè„¸...");
                    showLoading(true, true);
                    await detectFacesAndEmotions();
                }
            } catch (e) {
                console.error("Failed to load models:", e);
                statusDot.className = 'w-2 h-2 rounded-full bg-red-500 flex-shrink-0 animate-pulse';
                statusText.innerText = 'âŒ AI ç¦»çº¿';
                retryBtn.classList.remove('hidden');
                
                // æ˜¾ç¤ºæ›´è¯¦ç»†çš„é”™è¯¯æç¤ºï¼ˆä»…åœ¨æ§åˆ¶å°ï¼‰
                console.error("AIåŠ è½½å¤±è´¥è¯¦æƒ…:", {
                    error: e.message,
                    stack: e.stack,
                    modelUrl: MODEL_URL
                });
            }
            window.addEventListener('keydown', handleKeyDown);
            
            // Multi-select toggle listener
            document.getElementById('multiSelectToggle').addEventListener('change', (e) => {
                state.multiSelectMode = e.target.checked;
                state.selectedEmojis = [];
                updateMultiSelectUI();
                
                // é‡æ–°æ¸²æŸ“å½“å‰æ ‡ç­¾é¡µ
                if (state.activeTab === 'kay') {
                    renderKayStickers();
                } else if (state.activeTab === 'custom') {
                    renderCustomStickers();
                } else {
                    renderEmojiGrid(state.activeTab);
                }
            });
            
            setTimeout(resizeCanvas, 500);
        }
        
        // åŠ è½½æ¨¡å‹å‡½æ•°ï¼Œæ”¯æŒé™çº§å’Œç¼“å­˜
        async function loadModels() {
            try {
                console.log("Trying to load models from:", MODEL_URL);
                
                // ä½¿ç”¨æµè§ˆå™¨ç¼“å­˜APIï¼Œæ¨¡å‹ä¼šè¢«ç¼“å­˜
                // face-api.js å†…éƒ¨ä¼šä½¿ç”¨ fetchï¼Œæµè§ˆå™¨ä¼šè‡ªåŠ¨ç¼“å­˜å“åº”
                // æˆ‘ä»¬å¯ä»¥é€šè¿‡è®¾ç½® Cache-Control æ¥ä¼˜åŒ–ï¼Œä½†è¿™é‡Œä¾èµ–æµè§ˆå™¨é»˜è®¤ç¼“å­˜
                
                await Promise.all([
                    faceapi.nets.ssdMobilenetv1.loadFromUri(MODEL_URL),
                    faceapi.nets.faceExpressionNet.loadFromUri(MODEL_URL)
                ]);
                
                console.log("âœ… æ¨¡å‹åŠ è½½æˆåŠŸï¼ˆå·²ç¼“å­˜åˆ°æµè§ˆå™¨ï¼‰");
            } catch (e) {
                console.warn("Local models failed, falling back to GitHub CDN:", e);
                // å¦‚æœæœ¬åœ°å¤±è´¥ï¼Œä½¿ç”¨GitHub CDN
                MODEL_URL = MODEL_URL_GITHUB;
                await Promise.all([
                    faceapi.nets.ssdMobilenetv1.loadFromUri(MODEL_URL),
                    faceapi.nets.faceExpressionNet.loadFromUri(MODEL_URL)
                ]);
                console.log("âœ… æ¨¡å‹ä»CDNåŠ è½½æˆåŠŸï¼ˆå·²ç¼“å­˜åˆ°æµè§ˆå™¨ï¼‰");
            }
        }
        
        window.onload = init;
        
        // é‡è¯•åŠ è½½AIæ¨¡å‹
        async function retryLoadModels() {
            const statusDot = document.getElementById('aiStatusDot');
            const statusText = document.getElementById('aiStatusText');
            const retryBtn = document.getElementById('aiRetryBtn');
            
            try {
                retryBtn.disabled = true;
                retryBtn.innerText = 'â³ é‡è¯•ä¸­...';
                statusDot.className = 'w-2 h-2 rounded-full bg-yellow-500 flex-shrink-0 animate-pulse';
                statusText.innerText = 'ğŸ¤– AI é‡æ–°åŠ è½½ä¸­...';
                
                // é‡æ–°åŠ è½½æ¨¡å‹
                await loadModels();
                state.isModelLoaded = true;
                
                statusDot.className = 'w-2 h-2 rounded-full bg-green-500 flex-shrink-0';
                statusText.innerText = 'âœ… AI å°±ç»ª';
                retryBtn.classList.add('hidden');
                
                console.log("AI models reloaded successfully!");
            } catch (e) {
                console.error("Retry failed:", e);
                statusDot.className = 'w-2 h-2 rounded-full bg-red-500 flex-shrink-0 animate-pulse';
                statusText.innerText = 'âŒ AI ç¦»çº¿';
                retryBtn.disabled = false;
                retryBtn.innerText = 'ğŸ”„ é‡è¯•';
                retryBtn.classList.remove('hidden');
                
                // ç»™ç”¨æˆ·æ›´å‹å¥½çš„æç¤º
                alert('AI æ¨¡å‹åŠ è½½å¤±è´¥ ğŸ˜¢\n\nå¯èƒ½åŸå› ï¼š\n1. ç½‘ç»œè¿æ¥ä¸ç¨³å®š\n2. CDN èµ„æºåŠ è½½å¤±è´¥\n\nå»ºè®®ï¼š\nâ€¢ æ£€æŸ¥ç½‘ç»œè¿æ¥\nâ€¢ åˆ·æ–°é¡µé¢é‡è¯•\nâ€¢ ç¨åå†è¯•');
            }
        }

        // UIé€»è¾‘
        function switchTab(tabName) {
            state.activeTab = tabName;
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById(`tab-${tabName}`).classList.add('active');
            const grid = document.getElementById('emojiGrid');
            const customSection = document.getElementById('customSection');
            const kaySection = document.getElementById('kaySection');
            const multiSelectRow = document.getElementById('multiSelectToggleRow');
            
            // è¿½è¸ªæ ‡ç­¾åˆ‡æ¢
            trackEvent('switch_tab', {
                'event_category': 'User Interaction',
                'event_label': tabName
            });
            
            // éšè—æ‰€æœ‰åŒºåŸŸ
                grid.innerHTML = ''; 
            customSection.classList.add('hidden');
            kaySection.classList.add('hidden');
            
            // åœ¨æ‰€æœ‰æ ‡ç­¾éƒ½æ˜¾ç¤ºå¤šé€‰æ¨¡å¼ï¼ˆåŒ…æ‹¬è‡ªå®šä¹‰ï¼‰
            if (tabName === 'faces' || tabName === 'animals' || tabName === 'others' || tabName === 'kay' || tabName === 'custom') {
                multiSelectRow.classList.remove('hidden');
            } else {
                multiSelectRow.classList.add('hidden');
                // å…³é—­å¤šé€‰æ¨¡å¼
                if (state.multiSelectMode) {
                    document.getElementById('multiSelectToggle').checked = false;
                    state.multiSelectMode = false;
                    state.selectedEmojis = [];
                    updateMultiSelectUI();
                }
            }
            
            if (tabName === 'custom') {
                customSection.classList.remove('hidden');
                renderCustomStickers(); // æ¸²æŸ“å·²ä¿å­˜çš„è‡ªå®šä¹‰è´´çº¸
            } else if (tabName === 'kay') {
                kaySection.classList.remove('hidden');
                renderKayStickers();
            } else {
                renderEmojiGrid(tabName);
            }
        }
        
        // æ¸²æŸ“è‡ªå®šä¹‰è´´çº¸
        function renderCustomStickers() {
            const container = document.getElementById('customStickerContainer');
            container.innerHTML = '';
            state.customStickers.forEach(url => {
                const btn = document.createElement('button');
                const isMultiSelected = state.selectedEmojis.includes(url);
                
                let baseClass = 'col-span-1 aspect-square rounded-xl border-2 border-dashed border-black hover:bg-[#FF90E8] hover:text-white text-black flex items-center justify-center transition-colors bg-white sticker-btn overflow-hidden p-1 relative group';
                
                if (state.multiSelectMode && isMultiSelected) {
                    baseClass = 'col-span-1 aspect-square rounded-xl border-3 border-black bg-gradient-to-br from-purple-100 to-pink-100 transition-all overflow-hidden p-1 sticker-btn relative multi-selected group';
                }
                
                btn.className = baseClass;
                btn.innerHTML = `
                    <img src="${url}" class="custom-sticker-img">
                    <button onclick="deleteCustomSticker(event, '${url.replace(/'/g, "\\'")}', this.parentElement)" class="absolute top-1 right-1 w-6 h-6 bg-red-500 text-white rounded-full items-center justify-center text-xs font-bold opacity-0 group-hover:opacity-100 transition-opacity hidden group-hover:flex z-10" title="åˆ é™¤">Ã—</button>
                `;
                
                if (state.multiSelectMode) {
                    btn.onclick = function(e) {
                        if (e.target.tagName !== 'BUTTON') {
                            selectEmojiForMulti(url, this);
                        }
                    };
                } else {
                    btn.onclick = function(e) { 
                        if (e.target.tagName !== 'BUTTON') {
                            setManualSticker('image', url, this); 
                        }
                    };
                }
                container.appendChild(btn);
            });
        }

        function renderEmojiGrid(category) {
            const grid = document.getElementById('emojiGrid');
            grid.innerHTML = ''; 
            if (category === 'faces') {
                 const mosaicBtn = document.createElement('button');
                mosaicBtn.className = `sticker-btn w-10 h-10 sm:w-12 sm:h-12 flex items-center justify-center text-xl sm:text-2xl ${state.manualTool.content === 'mosaic' ? 'active' : ''}`;
                mosaicBtn.innerHTML = 'ğŸŒ«ï¸';
                mosaicBtn.onclick = () => setManualSticker('mosaic', 'mosaic', mosaicBtn);
                if (!state.multiSelectMode) grid.appendChild(mosaicBtn);
            }
            const list = EMOJI_DB[category] || [];
            const fragment = document.createDocumentFragment();
            list.forEach(emoji => {
                const btn = document.createElement('button');
                const isActive = state.manualTool.type === 'emoji' && state.manualTool.content === emoji;
                const isMultiSelected = state.selectedEmojis.includes(emoji);
                let classes = 'sticker-btn w-10 h-10 sm:w-12 sm:h-12 flex items-center justify-center text-xl sm:text-2xl';
                if (state.multiSelectMode && isMultiSelected) {
                    classes += ' multi-selected';
                } else if (!state.multiSelectMode && isActive) {
                    classes += ' active';
                }
                btn.className = classes;
                btn.innerText = emoji;
                
                if (state.multiSelectMode) {
                    btn.onclick = () => toggleEmojiSelection(emoji, btn);
                } else {
                btn.onclick = () => setManualSticker('emoji', emoji, btn);
                }
                fragment.appendChild(btn);
            });
            grid.appendChild(fragment);
        }

        // ä¸šåŠ¡é€»è¾‘
        function triggerUpload() { document.getElementById('imageUpload').click(); }

        function handleImageUpload(e) {
            const file = e.target.files[0];
            if (!file) return;
            if (state.scanTimeout) clearTimeout(state.scanTimeout);

            const reader = new FileReader();
            reader.onload = (event) => {
                const img = new Image();
                img.onload = async () => {
                    state.img = img;
                    state.masks = [];
                    state.selectedMaskIndex = -1;
                    
                    // ç«‹å³æ¸²æŸ“
                    resizeCanvas();
                    document.getElementById('placeholderText').classList.add('hidden');
                    document.getElementById('downloadBtn').classList.remove('hidden');
                    const mobileReroll = document.getElementById('rerollControls');
                    if (mobileReroll) mobileReroll.classList.add('hidden');
                    document.getElementById('rerollControlsDesktop').classList.add('hidden');
                    document.getElementById('uploadBtnText').innerText = i18n[state.language].changePhoto;
                    
                    // ç§»åŠ¨ç«¯ï¼šæ˜¾ç¤ºè´´çº¸é€‰æ‹©åŒº
                    const stickerSection = document.getElementById('stickerSection');
                    if (stickerSection && window.innerWidth < 1024) {
                        stickerSection.classList.remove('hidden');
                        stickerSection.classList.add('flex');
                    }
                    
                    showLoading(true, true);
                    await detectFacesAndEmotions();
                };
                img.src = event.target.result;
            };
            reader.readAsDataURL(file);
            
            // è¿½è¸ªå›¾ç‰‡ä¸Šä¼ äº‹ä»¶
            trackEvent('upload_image', {
                'event_category': 'User Interaction',
                'event_label': 'Image Upload'
            });
        }

        function handleCustomFileUpload(e) {
            const files = Array.from(e.target.files);
            if (files.length === 0) return;
            const shouldRemoveBg = document.getElementById('bgRemoveToggle').checked;
            files.forEach(file => {
                const reader = new FileReader();
                reader.onload = (event) => {
                    let url = event.target.result;
                    if (shouldRemoveBg) {
                        processRemoveBackground(url, (processedUrl) => addCustomStickerToLibrary(processedUrl));
                    } else {
                        addCustomStickerToLibrary(url);
                    }
                };
                reader.readAsDataURL(file);
            });
            switchTab('custom');
        }

        function processRemoveBackground(imgSrc, callback) {
            const img = new Image();
            img.onload = () => {
                const c = document.createElement('canvas');
                const ctx = c.getContext('2d');
                c.width = img.width;
                c.height = img.height;
                ctx.drawImage(img, 0, 0);
                const imageData = ctx.getImageData(0, 0, c.width, c.height);
                const data = imageData.data;
                const r0 = data[0], g0 = data[1], b0 = data[2];
                const threshold = 30;
                for (let i = 0; i < data.length; i += 4) {
                    const dist = Math.sqrt((data[i]-r0)**2 + (data[i+1]-g0)**2 + (data[i+2]-b0)**2);
                    if (dist < threshold) data[i+3] = 0;
                }
                ctx.putImageData(imageData, 0, 0);
                callback(c.toDataURL());
            };
            img.src = imgSrc;
        }

        function promptForCustomSticker() {
            const input = prompt("è¾“å…¥å›¾ç‰‡é“¾æ¥ï¼ˆé€—å·åˆ†éš”ï¼‰:", "https://");
            if (!input) return;
            input.split(/[\n,]+/).map(u => u.trim()).filter(u => u && u !== "https://").forEach(u => addCustomStickerToLibrary(u));
            switchTab('custom');
        }

        function addCustomStickerToLibrary(url) {
            if (state.customStickers.includes(url)) return;
            state.customStickers.push(url);
            saveCustomStickersToStorage(); // ä¿å­˜åˆ°æœ¬åœ°
            
            const container = document.getElementById('customStickerContainer');
            const btn = document.createElement('button');
            btn.className = 'col-span-1 aspect-square rounded-xl border-2 border-dashed border-black hover:bg-[#FF90E8] hover:text-white text-black flex items-center justify-center transition-colors bg-white sticker-btn overflow-hidden p-1 relative group';
            btn.innerHTML = `
                <img src="${url}" class="custom-sticker-img">
                <button onclick="deleteCustomSticker(event, '${url.replace(/'/g, "\\'")}', this.parentElement)" class="absolute top-1 right-1 w-6 h-6 bg-red-500 text-white rounded-full items-center justify-center text-xs font-bold opacity-0 group-hover:opacity-100 transition-opacity hidden group-hover:flex z-10" title="åˆ é™¤">Ã—</button>
            `;
            btn.onclick = function(e) { 
                if (e.target.tagName !== 'BUTTON') {
                    setManualSticker('image', url, this); 
                }
            };
            container.insertBefore(btn, container.firstChild);
        }
        
        // åˆ é™¤è‡ªå®šä¹‰è´´çº¸
        function deleteCustomSticker(event, url, btnElement) {
            event.stopPropagation();
            if (confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªè´´çº¸å—ï¼Ÿ')) {
                const index = state.customStickers.indexOf(url);
                if (index > -1) {
                    state.customStickers.splice(index, 1);
                    saveCustomStickersToStorage();
                }
                btnElement.remove();
            }
        }
        
        // ä¿å­˜è‡ªå®šä¹‰è´´çº¸åˆ°æœ¬åœ°å­˜å‚¨
        function saveCustomStickersToStorage() {
            try {
                localStorage.setItem('facejam_custom_stickers', JSON.stringify(state.customStickers));
            } catch (e) {
                console.error('Failed to save custom stickers:', e);
            }
        }
        
        // ä»æœ¬åœ°å­˜å‚¨åŠ è½½è‡ªå®šä¹‰è´´çº¸
        function loadCustomStickersFromStorage() {
            try {
                const saved = localStorage.getItem('facejam_custom_stickers');
                if (saved) {
                    const stickers = JSON.parse(saved);
                    stickers.forEach(url => {
                        if (!state.customStickers.includes(url)) {
                            state.customStickers.push(url);
                            // ä¸ç«‹å³æ¸²æŸ“ï¼Œç­‰åˆ‡æ¢åˆ°è‡ªå®šä¹‰æ ‡ç­¾æ—¶å†æ¸²æŸ“
                        }
                    });
                }
            } catch (e) {
                console.error('Failed to load custom stickers:', e);
            }
        }
        
        // æ¸²æŸ“Kayçš„è´´çº¸
        function renderKayStickers() {
            const container = document.getElementById('kayStickers');
            container.innerHTML = '';
            
            EMOJI_DB.kay.forEach(sticker => {
                // åˆ›å»ºåŒ…è£…å®¹å™¨
                const wrapper = document.createElement('div');
                wrapper.className = 'flex flex-col items-center gap-1';
                
                // åˆ›å»ºæŒ‰é’®
                const btn = document.createElement('button');
                const url = `./assets/${sticker.name}`;
                const isMultiSelected = state.selectedEmojis.includes(url);
                
                let classes = 'aspect-square rounded-xl border-2 border-black hover:border-pink-500 bg-white hover:bg-pink-50 transition-all overflow-hidden p-2 sticker-btn shadow-hard-sm hover:shadow-hard w-full';
                if (state.multiSelectMode && isMultiSelected) {
                    classes = 'aspect-square rounded-xl border-3 border-black bg-gradient-to-br from-purple-100 to-pink-100 transition-all overflow-hidden p-2 sticker-btn shadow-hard relative multi-selected w-full';
                }
                
                btn.className = classes;
                btn.innerHTML = `
                    <img src="${url}" class="w-full h-full object-contain" alt="${sticker.title}">
                `;
                
                if (state.multiSelectMode) {
                    btn.onclick = () => toggleEmojiSelection(url, btn);
                } else {
                    btn.onclick = () => setManualSticker('image', url, btn);
                }
                
                btn.title = sticker.title;
                
                // åˆ›å»ºåå­—æ ‡ç­¾ï¼ˆåœ¨æ¡†å¤–ï¼‰
                const label = document.createElement('div');
                label.className = 'text-[10px] font-bold text-gray-600 text-center truncate w-full px-1';
                label.innerText = sticker.title;
                
                // ç»„è£…
                wrapper.appendChild(btn);
                wrapper.appendChild(label);
                container.appendChild(wrapper);
            });
        }

        function resizeCanvas() {
            const container = canvas.parentElement;
            const maxWidth = container.clientWidth; 
            const maxHeight = container.clientHeight;

            if (!state.img) {
                if (maxWidth > 0 && maxHeight > 0) {
                     canvas.style.width = maxWidth + 'px';
                     canvas.style.height = maxHeight + 'px';
                     canvas.width = maxWidth * state.dpr;
                     canvas.height = maxHeight * state.dpr;
                     ctx.scale(state.dpr, state.dpr);
                }
                return;
            }

            let w = state.img.width;
            let h = state.img.height;
            const scaleW = maxWidth / w;
            const scaleH = maxHeight / h;
            const scale = Math.min(scaleW, scaleH, 1);

            canvas.style.width = (w * scale) + 'px';
            canvas.style.height = (h * scale) + 'px';
            canvas.width = (w * scale) * state.dpr;
            canvas.height = (h * scale) * state.dpr;
            ctx.scale(state.dpr, state.dpr);
            state.scale = scale;
            
            const rect = canvas.getBoundingClientRect();
            state.canvasOffset = { left: rect.left, top: rect.top };
            render();
        }

        async function detectFacesAndEmotions() {
            state.scanTimeout = setTimeout(() => { showLoading(false); console.warn("Timeout"); }, 15000);

            if (!state.isModelLoaded) await init();
            if (!state.isModelLoaded) { showLoading(false); return; }
            
            const progressBar = document.getElementById('loadingProgress');
            const loadingText = document.getElementById('loadingTitle');
            
            try {
                progressBar.style.width = '20%';
                loadingText.innerText = i18n[state.language].loadingScanning;
                const options = new faceapi.SsdMobilenetv1Options({ minConfidence: 0.25 });
                await new Promise(r => setTimeout(r, 500));
                
                progressBar.style.width = '60%';
                const results = await faceapi.detectAllFaces(state.img, options).withFaceExpressions();
                
                progressBar.style.width = '95%';
                state.rawDetections = results;
                
                if (results.length > 0) {
                     generateMasksFromDetections();
                     
                    // ç§»åŠ¨ç«¯ï¼šæ˜¾ç¤ºç«–ç›´æŒ‰é’®
                    const mobileReroll = document.getElementById('rerollControls');
                    if (mobileReroll && window.innerWidth < 1024) {
                        mobileReroll.classList.remove('hidden');
                        mobileReroll.classList.add('flex');
                    }
                    
                    // æ¡Œé¢ç«¯ï¼šæ˜¾ç¤ºæ°´å¹³æŒ‰é’®
                    const desktopReroll = document.getElementById('rerollControlsDesktop');
                    if (desktopReroll && window.innerWidth >= 1024) {
                        desktopReroll.classList.remove('hidden');
                        desktopReroll.classList.add('flex');
                    }
                     
                     // è¿½è¸ªäººè„¸æ£€æµ‹æˆåŠŸ
                     trackEvent('face_detected', {
                         'event_category': 'AI Processing',
                         'event_label': 'Face Detection Success',
                         'value': results.length
                     });
                }
                updateMaskCount();
                progressBar.style.width = '100%';
                await new Promise(r => setTimeout(r, 300));
            } catch (err) {
                console.error(err);
            } finally {
                if (state.scanTimeout) clearTimeout(state.scanTimeout);
                showLoading(false);
                render();
            }
        }

        function generateMasksFromDetections(category = 'default') {
            state.masks = []; 
            state.selectedMaskIndex = -1;
            
            let sessionPool = [];
            if (category !== 'default') {
                let pool;
                if (category === 'custom') {
                    pool = state.customStickers;
                } else if (category === 'kay') {
                    pool = EMOJI_DB.kay.map(s => `./assets/${s.name}`);
                } else if (category === 'chaos') {
                    pool = [...EMOJI_DB.animals, ...EMOJI_DB.plants, ...EMOJI_DB.others];
                } else {
                    pool = EMOJI_DB[category];
                }
                if (!pool || pool.length === 0) { alert("æ²¡æœ‰å¯ç”¨è´´çº¸"); return; }
                sessionPool = [...pool].sort(() => 0.5 - Math.random()).slice(0, 10);
            }

            state.rawDetections.forEach(result => {
                const box = result.detection.box;
                let randomEmoji, type = 'emoji';
                
                if (category === 'default') {
                    const emotionName = result.expressions.asSortedArray()[0].expression;
                    const list = AI_EMOTION_MAP[emotionName] || AI_EMOTION_MAP['neutral'];
                    randomEmoji = list[Math.floor(Math.random() * list.length)];
                } else {
                    randomEmoji = sessionPool[Math.floor(Math.random() * sessionPool.length)];
                    if (category === 'custom' || category === 'kay') type = 'image';
                }

                const s = state.scale;
                state.masks.push({
                    x: (box.x * s) + (box.width * s / 2),
                    y: (box.y * s) + (box.height * s / 2),
                    size: Math.max(box.width * s, box.height * s) * 1.4,
                    type: type,
                    content: randomEmoji,
                    detectedEmotion: category === 'default' ? result.expressions.asSortedArray()[0].expression : null
                });
            });
            render();
        }

        async function rerollCategory(category) {
            if (state.rawDetections.length === 0) return;
            if (category === 'custom' && state.customStickers.length === 0) {
                alert("è¯·å…ˆä¸Šä¼ è‡ªå®šä¹‰å›¾ç‰‡"); switchTab('custom'); return;
            }
            showLoading(true, false);
            document.getElementById('loadingTitle').innerText = i18n[state.language].loadingApplying;
            await new Promise(r => setTimeout(r, 800));
            generateMasksFromDetections(category);
            showLoading(false);
        }

        function render() {
            if (!state.img) return;
            const cssW = canvas.width / state.dpr;
            const cssH = canvas.height / state.dpr;
            ctx.clearRect(0, 0, cssW, cssH);
            ctx.drawImage(state.img, 0, 0, cssW, cssH);

            state.masks.forEach((mask, i) => {
                ctx.save();
                ctx.translate(mask.x, mask.y);

                if (i === state.selectedMaskIndex) {
                    ctx.strokeStyle = '#000'; ctx.lineWidth = 3; ctx.setLineDash([6, 6]);
                    ctx.beginPath(); ctx.arc(0, 0, mask.size / 1.7, 0, Math.PI * 2); ctx.stroke();
                    ctx.fillStyle = '#FFC900'; ctx.strokeStyle = '#000'; ctx.lineWidth = 2; ctx.setLineDash([]);
                    ctx.beginPath(); ctx.arc(0, mask.size / 1.7, 8, 0, Math.PI * 2); ctx.fill(); ctx.stroke();
                }

                if (mask.type === 'mosaic') {
                    ctx.fillStyle = 'rgba(255, 255, 255, 0.3)'; ctx.beginPath(); ctx.arc(0, 0, mask.size / 2, 0, Math.PI * 2); ctx.fill();
                    ctx.fillStyle = '#FFF'; ctx.font = `800 ${mask.size * 0.15}px sans-serif`;
                    ctx.textAlign = 'center'; ctx.textBaseline = 'middle'; ctx.fillText('MASK', 0, 0);
                } else if (mask.type === 'emoji') {
                    ctx.font = `${mask.size}px "Segoe UI Emoji", sans-serif`;
                    ctx.textAlign = 'center'; ctx.textBaseline = 'middle';
                    ctx.shadowColor = "rgba(0,0,0,0.3)"; ctx.shadowBlur = 0; ctx.shadowOffsetX = 4; ctx.shadowOffsetY = 4;
                    ctx.fillText(mask.content, 0, mask.size * 0.12);
                } else if (mask.type === 'image') {
                    const img = state.loadedStickerImages[mask.content];
                    if (!img) loadSticker(mask.content).then(() => render());
                    else {
                        ctx.shadowColor = "rgba(0,0,0,0.2)"; ctx.shadowBlur = 4;
                        ctx.drawImage(img, -mask.size / 2, -mask.size / 2, mask.size, mask.size);
                    }
                }
                ctx.restore();
            });
            
            // ç»˜åˆ¶æ°´å°ï¼ˆå¦‚æœæœªç§»é™¤ï¼‰
            if (!state.watermarkRemoved && state.img) {
                drawWatermark(ctx, cssW, cssH);
            }
            
            const toolbar = document.getElementById('floatingToolbar');
            const emoDisplay = document.getElementById('detectedEmotionDisplay');
            if (state.selectedMaskIndex !== -1) {
                toolbar.classList.remove('hidden'); toolbar.classList.add('flex');
                document.getElementById('sizeSlider').value = state.masks[state.selectedMaskIndex].size;
            } else {
                toolbar.classList.add('hidden'); toolbar.classList.remove('flex');
            }
        }

        function setManualSticker(type, content, btn) {
            state.manualTool = { type, content };
            document.querySelectorAll('.sticker-btn').forEach(b => b.classList.remove('active'));
            if (btn) btn.classList.add('active');
            if (state.selectedMaskIndex !== -1) {
                state.masks[state.selectedMaskIndex].type = type;
                state.masks[state.selectedMaskIndex].content = content;
                render();
            }
        }

        function handleStart(e) {
            if (!state.img) return;
            if (e.target !== canvas) return;
            e.preventDefault();
            const pos = getPos(e);
            let clickedIndex = -1, isHandle = false;

            for (let i = state.masks.length - 1; i >= 0; i--) {
                const mask = state.masks[i];
                const handleY = mask.y + (mask.size / 1.7);
                if ((pos.x-mask.x)**2 + (pos.y-handleY)**2 < 400) { clickedIndex = i; isHandle = true; break; }
                if ((pos.x-mask.x)**2 + (pos.y-mask.y)**2 < (mask.size/1.8)**2) { clickedIndex = i; break; }
            }

            if (clickedIndex !== -1) {
                state.selectedMaskIndex = clickedIndex;
                state.isResizing = isHandle;
                state.isDragging = !isHandle;
                if (!isHandle) state.dragOffset = { x: pos.x - state.masks[clickedIndex].x, y: pos.y - state.masks[clickedIndex].y };
            } else {
                state.masks.push({
                    x: pos.x, y: pos.y, size: 100, type: state.manualTool.type, content: state.manualTool.content
                });
                state.selectedMaskIndex = state.masks.length - 1;
                state.isResizing = false; state.isDragging = false;
                updateMaskCount();
            }
            render();
        }

        function getPos(e) {
            const rect = canvas.getBoundingClientRect();
            const cx = e.touches ? e.touches[0].clientX : e.clientX;
            const cy = e.touches ? e.touches[0].clientY : e.clientY;
            return { x: cx - rect.left, y: cy - rect.top };
        }
        
        function handleMove(e) {
            if (state.selectedMaskIndex === -1 || (!state.isDragging && !state.isResizing)) return;
            e.preventDefault();
            const rect = canvas.getBoundingClientRect();
            const cx = e.touches ? e.touches[0].clientX : e.clientX;
            const cy = e.touches ? e.touches[0].clientY : e.clientY;
            const mx = cx - rect.left, my = cy - rect.top;
            const mask = state.masks[state.selectedMaskIndex];

            if (state.isDragging) {
                mask.x = mx - state.dragOffset.x; mask.y = my - state.dragOffset.y;
            } else if (state.isResizing) {
                const dist = Math.sqrt((mx - mask.x)**2 + (my - mask.y)**2);
                mask.size = Math.max(20, Math.min(dist * 1.7, 800));
            }
            render();
        }

        canvas.addEventListener('mousedown', handleStart);
        canvas.addEventListener('touchstart', handleStart);
        window.addEventListener('mousemove', handleMove);
        window.addEventListener('touchmove', handleMove, { passive: false });
        window.addEventListener('mouseup', () => { state.isDragging = false; state.isResizing = false; });
        window.addEventListener('touchend', () => { state.isDragging = false; state.isResizing = false; });

        function updateSelectedSize(val) {
            if (state.selectedMaskIndex !== -1) {
                state.masks[state.selectedMaskIndex].size = parseInt(val);
                render();
            }
        }
        function deleteSelected() {
            if (state.selectedMaskIndex !== -1) {
                state.masks.splice(state.selectedMaskIndex, 1);
                state.selectedMaskIndex = -1;
                render();
                updateMaskCount();
            }
        }
        function handleKeyDown(e) {
            if (state.selectedMaskIndex !== -1 && ['Enter','Backspace','Delete'].includes(e.key)) {
                e.preventDefault(); deleteSelected();
            }
        }
        function updateMaskCount() { document.getElementById('maskCount').innerText = `${state.masks.length} ${i18n[state.language].maskCount}`; }
        
        function loadSticker(url) {
            return new Promise(resolve => {
                if (state.loadedStickerImages[url]) return resolve(state.loadedStickerImages[url]);
                const img = new Image();
                // åªå¯¹å¤–éƒ¨URLè®¾ç½®crossOrigin
                if (url.startsWith('http://') || url.startsWith('https://')) {
                img.crossOrigin = "anonymous";
                }
                img.onload = () => { state.loadedStickerImages[url] = img; resolve(img); };
                img.onerror = () => { 
                    console.error('Failed to load image:', url); 
                    resolve(null); 
                };
                img.src = url;
            });
        }
        
        // Multi-select functions
        function toggleEmojiSelection(emoji, btn) {
            const index = state.selectedEmojis.indexOf(emoji);
            if (index > -1) {
                state.selectedEmojis.splice(index, 1);
                btn.classList.remove('multi-selected');
            } else {
                state.selectedEmojis.push(emoji);
                btn.classList.add('multi-selected');
            }
            updateMultiSelectUI();
        }
        
        function updateMultiSelectUI() {
            const applyBtn = document.getElementById('multiSelectApplyBtn');
            const count = document.getElementById('multiSelectCount');
            count.innerText = state.selectedEmojis.length;
            
            if (state.multiSelectMode && state.selectedEmojis.length > 0) {
                applyBtn.classList.remove('hidden');
            } else {
                applyBtn.classList.add('hidden');
            }
        }
        
        function applyMultiSelectEmojis() {
            if (state.selectedEmojis.length === 0) {
                alert('è¯·å…ˆé€‰æ‹©emojiæˆ–è´´çº¸');
                return;
            }
            if (state.rawDetections.length === 0) {
                alert('è¯·å…ˆä¸Šä¼ ç…§ç‰‡');
                return;
            }
            
            // æ˜¾ç¤ºæ¿€å…‰æ‰«æç‰¹æ•ˆ
            showLoading(true, false);
            document.getElementById('loadingTitle').innerText = i18n[state.language].loadingApplying;
            document.getElementById('loadingProgress').style.width = '30%';
            
            setTimeout(() => {
                document.getElementById('loadingProgress').style.width = '70%';
                
                // Apply selected emojis to all detected faces
                state.masks = [];
                state.selectedMaskIndex = -1;
                
                state.rawDetections.forEach((result, index) => {
                    const box = result.detection.box;
                    const content = state.selectedEmojis[index % state.selectedEmojis.length];
                    const s = state.scale;
                    
                    // åˆ¤æ–­æ˜¯emojiè¿˜æ˜¯å›¾ç‰‡URL
                    const isImage = content.includes('./assets/') || content.includes('http');
                    
                    state.masks.push({
                        x: (box.x * s) + (box.width * s / 2),
                        y: (box.y * s) + (box.height * s / 2),
                        size: Math.max(box.width * s, box.height * s) * 1.4,
                        type: isImage ? 'image' : 'emoji',
                        content: content,
                        detectedEmotion: null
                    });
                });
                
                document.getElementById('loadingProgress').style.width = '100%';
                updateMaskCount();
                
                setTimeout(() => {
                    showLoading(false);
                    render();
                }, 300);
                
                // è¿½è¸ªå¤šé€‰åº”ç”¨
                trackEvent('apply_multi_select', {
                    'event_category': 'Feature Usage',
                    'event_label': 'Multi Select',
                    'value': state.selectedEmojis.length
                });
            }, 600);
        }

        function showLoading(show, isSlow) {
            const el = document.getElementById('loadingOverlay');
            const scan = document.getElementById('scanLine');
            if (show) {
                el.classList.remove('hidden'); el.classList.add('flex');
                document.getElementById('loadingProgress').style.width = '0%';
                scan.style.animationDuration = isSlow ? '1.5s' : '0.8s';
            } else {
                el.classList.add('hidden'); el.classList.remove('flex');
            }
        }
        
        // ç»˜åˆ¶æ°´å°
        function drawWatermark(ctx, width, height) {
            ctx.save();
            
            // åŠé€æ˜ç™½è‰²èƒŒæ™¯
            const padding = 8;
            const cornerRadius = 12;
            const fontSize = Math.min(width, height) * 0.035; // å“åº”å¼å­—ä½“å¤§å°
            const x = 15;
            const y = height - 15;
            
            // è®¾ç½®å­—ä½“
            ctx.font = `bold ${fontSize}px "Fredoka", sans-serif`;
            const text = 'ğŸ¥° FaceJam.cc';
            const textWidth = ctx.measureText(text).width;
            const bgWidth = textWidth + padding * 2;
            const bgHeight = fontSize + padding * 2;
            
            // ç»˜åˆ¶åœ†è§’çŸ©å½¢èƒŒæ™¯
            ctx.fillStyle = 'rgba(255, 255, 255, 0.92)';
            ctx.beginPath();
            ctx.moveTo(x + cornerRadius, y - bgHeight);
            ctx.lineTo(x + bgWidth - cornerRadius, y - bgHeight);
            ctx.quadraticCurveTo(x + bgWidth, y - bgHeight, x + bgWidth, y - bgHeight + cornerRadius);
            ctx.lineTo(x + bgWidth, y - cornerRadius);
            ctx.quadraticCurveTo(x + bgWidth, y, x + bgWidth - cornerRadius, y);
            ctx.lineTo(x + cornerRadius, y);
            ctx.quadraticCurveTo(x, y, x, y - cornerRadius);
            ctx.lineTo(x, y - bgHeight + cornerRadius);
            ctx.quadraticCurveTo(x, y - bgHeight, x + cornerRadius, y - bgHeight);
            ctx.closePath();
            ctx.fill();
            
            // ç»˜åˆ¶è¾¹æ¡†
            ctx.strokeStyle = '#000';
            ctx.lineWidth = 2;
            ctx.stroke();
            
            // ç»˜åˆ¶æ–‡å­—
            ctx.fillStyle = '#FF90E8';
            ctx.textAlign = 'left';
            ctx.textBaseline = 'middle';
            ctx.fillText(text, x + padding, y - bgHeight / 2);
            
            ctx.restore();
        }
        
        // æ¿€æ´»ç éªŒè¯
        function validateActivationCode(code) {
            code = code.trim();
            if (!code) return { success: false, message: 'è¯·è¾“å…¥æ¿€æ´»ç ' };
            
            // æ£€æŸ¥æ˜¯å¦å·²ä½¿ç”¨è¿‡æ­¤ä»£ç 
            const usedCodes = JSON.parse(localStorage.getItem('facejam_used_codes') || '{}');
            
            if (ACTIVATION_CODES[code]) {
                const codeInfo = ACTIVATION_CODES[code];
                const usedCount = usedCodes[code] || 0;
                
                if (codeInfo.uses === Infinity) {
                    // ä¸‡èƒ½ä»£ç ï¼ˆä¸é€éœ²æ˜¯ä¸‡èƒ½ç ï¼‰
                    return { success: true, message: 'æ¿€æ´»æˆåŠŸï¼æ­¤ä»£ç å¯åœ¨2å°è®¾å¤‡ä½¿ç”¨' };
                } else if (usedCount < codeInfo.uses) {
                    // æ™®é€šä»£ç è¿˜æœ‰å‰©ä½™æ¬¡æ•°
                    usedCodes[code] = usedCount + 1;
                    localStorage.setItem('facejam_used_codes', JSON.stringify(usedCodes));
                    const remaining = codeInfo.uses - usedCodes[code];
                    return { 
                        success: true, 
                        message: `æ¿€æ´»æˆåŠŸï¼æ­¤ä»£ç å¯åœ¨2å°è®¾å¤‡ä½¿ç”¨${remaining > 0 ? 'ï¼Œè¿˜å‰© ' + remaining + ' æ¬¡' : ''}`,
                        remaining: remaining
                    };
                } else {
                    return { success: false, message: 'æ­¤æ¿€æ´»ç å·²è¾¾ä½¿ç”¨æ¬¡æ•°ä¸Šé™' };
                }
            }
            
            return { success: false, message: 'æ¿€æ´»ç æ— æ•ˆï¼Œè¯·æ£€æŸ¥åé‡è¯•' };
        }
        
        // æ˜¾ç¤ºæ¿€æ´»ç å¼¹çª—
        function showActivationModal() {
            const modal = document.getElementById('activationModal');
            modal.classList.remove('hidden');
            modal.classList.add('flex');
            document.getElementById('activationCodeInput').value = '';
            document.getElementById('activationCodeInput').focus();
            
            // ç§»åŠ¨ç«¯ï¼šéšè—å³ä¾§"å†è´´ä¸€æ¬¡"æŒ‰é’®
            const rerollControls = document.getElementById('rerollControls');
            if (rerollControls && window.innerWidth < 1024) {
                rerollControls.style.display = 'none';
            }
        }
        
        // å…³é—­æ¿€æ´»ç å¼¹çª—
        function closeActivationModal() {
            const modal = document.getElementById('activationModal');
            modal.classList.add('hidden');
            modal.classList.remove('flex');
            
            // ç§»åŠ¨ç«¯ï¼šæ¢å¤å³ä¾§"å†è´´ä¸€æ¬¡"æŒ‰é’®æ˜¾ç¤º
            const rerollControls = document.getElementById('rerollControls');
            if (rerollControls && window.innerWidth < 1024 && state.img) {
                rerollControls.style.display = 'flex';
            }
        }
        
        // æäº¤æ¿€æ´»ç 
        function submitActivationCode() {
            const code = document.getElementById('activationCodeInput').value;
            const result = validateActivationCode(code);
            const messageEl = document.getElementById('activationMessage');
            
            if (result.success) {
                messageEl.className = 'text-sm font-bold text-green-600 mt-2';
                messageEl.textContent = result.message;
                state.watermarkRemoved = true;
                localStorage.setItem('facejam_watermark_removed', 'true');
                
                // æ›´æ–°æŒ‰é’®çŠ¶æ€
                const btn = document.getElementById('watermarkBtn');
                const btnText = document.getElementById('watermarkBtnText');
                if (btn && btnText) {
                    btn.className = 'bg-green-600 hover:bg-green-700 text-white px-2 sm:px-3 py-1 rounded-full transition-all text-[10px] sm:text-xs font-bold';
                    btnText.textContent = 'âœ“ å·²æ¿€æ´»';
                }
                
                render();
                setTimeout(() => {
                    closeActivationModal();
                }, 1500);
                
                // è¿½è¸ªæ¿€æ´»æˆåŠŸäº‹ä»¶
                trackEvent('activation_success', {
                    'event_category': 'Monetization',
                    'event_label': 'Watermark Removal'
                });
            } else {
                messageEl.className = 'text-sm font-bold text-red-600 mt-2';
                messageEl.textContent = result.message;
            }
        }
        
        function downloadImage() {
            if (!state.img) return;
            const link = document.createElement('a');
            link.download = 'facejam_' + Date.now() + '.png';
            link.href = canvas.toDataURL();
            link.click();
            
            // è¿½è¸ªä¸‹è½½äº‹ä»¶
            trackEvent('download_image', {
                'event_category': 'User Interaction',
                'event_label': 'Image Download',
                'activated': state.isActivated ? 'Yes' : 'No'
            });
        }
        
        // æ¬¢è¿å¼¹çª—æ§åˆ¶
        function closeWelcomeModal() {
            const modal = document.getElementById('welcomeModal');
            modal.style.animation = 'fadeOut 0.3s ease-out';
            setTimeout(() => {
                modal.style.display = 'none';
                localStorage.setItem('facejam_welcomed', 'true');
            }, 300);
        }
        
        // æ£€æŸ¥æ˜¯å¦å·²ç»çœ‹è¿‡æ¬¢è¿å¼¹çª—
        window.addEventListener('load', () => {
            const hasSeenWelcome = localStorage.getItem('facejam_welcomed');
            if (hasSeenWelcome) {
                document.getElementById('welcomeModal').style.display = 'none';
            }
            
            // åŠ è½½ä¿å­˜çš„è¯­è¨€è®¾ç½®
            const savedLang = localStorage.getItem('facejam_language');
            if (savedLang && savedLang !== state.language) {
                state.language = savedLang;
                updateLanguage();
            }
            
            // æ£€æŸ¥æ°´å°æ¿€æ´»çŠ¶æ€
            const watermarkRemoved = localStorage.getItem('facejam_watermark_removed');
            if (watermarkRemoved === 'true') {
                state.watermarkRemoved = true;
                const btn = document.getElementById('watermarkBtn');
                const btnText = document.getElementById('watermarkBtnText');
                if (btn && btnText) {
                    btn.className = 'bg-green-600 hover:bg-green-700 text-white px-2 sm:px-3 py-1 rounded-full transition-all text-[10px] sm:text-xs font-bold';
                    btnText.textContent = 'âœ“ å·²æ¿€æ´»';
                }
            }
        });
        
        // åˆ‡æ¢è¯­è¨€
        function toggleLanguage() {
            state.language = state.language === 'zh' ? 'en' : 'zh';
            localStorage.setItem('facejam_language', state.language);
            updateLanguage();
        }
        
        // æ›´æ–°ç•Œé¢è¯­è¨€
        function updateLanguage() {
            const t = i18n[state.language];
            
            // æ›´æ–°æŒ‰é’®æ–‡å­—
            document.getElementById('langIcon').innerText = state.language === 'zh' ? 'EN' : 'ä¸­';
            document.getElementById('downloadBtnText').innerText = t.download;
            document.getElementById('uploadBtnText').innerText = state.img ? t.changePhoto : t.upload;
            
            // æ›´æ–°æ ‡ç­¾é¡µ
            document.getElementById('tab-faces').innerText = t.tabFaces;
            document.getElementById('tab-animals').innerText = t.tabAnimals;
            document.getElementById('tab-kay').innerText = t.tabKay;
            document.getElementById('tab-others').innerText = t.tabOthers;
            document.getElementById('tab-custom').innerText = t.tabCustom;
            
            // æ›´æ–°çŠ¶æ€æ 
            if (state.isModelLoaded) {
                document.getElementById('aiStatusText').innerText = 'âœ… ' + t.aiReady;
            } else {
                const statusText = document.getElementById('aiStatusText').innerText;
                // å¦‚æœæ˜¯ç¦»çº¿çŠ¶æ€ï¼Œä¿æŒ"âŒ AI ç¦»çº¿"
                if (!statusText.includes('ç¦»çº¿') && !statusText.includes('Offline')) {
                    document.getElementById('aiStatusText').innerText = 'ğŸ¤– ' + t.aiPreparing;
                }
            }
            document.getElementById('maskCount').innerText = `${state.masks.length} ${t.maskCount}`;
            
            // æ›´æ–°å ä½ç¬¦æ–‡æœ¬ï¼ˆä½¿ç”¨dataå±æ€§æ¥å­˜å‚¨åŠ¨æ€å†…å®¹ï¼‰
            updateWelcomeModal();
        }
        
        // æ›´æ–°æ¬¢è¿å¼¹çª—æ–‡æœ¬
        function updateWelcomeModal() {
            const t = i18n[state.language];
            const modal = document.getElementById('welcomeModal');
            if (!modal) return;
            
            // è¿™é‡Œå¯ä»¥é€‰æ‹©æ€§åœ°æ›´æ–°å¼¹çª—å†…å®¹ï¼Œæˆ–è€…åœ¨æ‰“å¼€æ—¶åŠ¨æ€ç”Ÿæˆ
            // ä¸ºäº†ç®€åŒ–ï¼Œæˆ‘ä»¬åªåœ¨åˆæ¬¡æ‰“å¼€æ—¶ä½¿ç”¨å½“å‰è¯­è¨€
        }
    </script>
</body>
</html>